<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç”Ÿç‰©é«”å…§çš„é‹è¼¸ï½œäº”é—œå¡äº’å‹•éŠæˆ²ï¼ˆæ˜äº®ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f5f7ff;
      --bg2:#ffffff;
      --card:#ffffff;
      --card2:#f2f5ff;
      --text:#0f172a;
      --muted:#475569;
      --good:#16a34a;
      --bad:#e11d48;
      --warn:#f59e0b;
      --line:#dbe2ff;
      --btn:#2563eb;
      --btn2:#e6ecff;
      --shadow:0 14px 30px rgba(2,6,23,.10);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(37,99,235,.18) 0%, rgba(37,99,235,0) 60%),
        radial-gradient(1000px 650px at 90% 12%, rgba(34,197,94,.16) 0%, rgba(34,197,94,0) 60%),
        linear-gradient(180deg, var(--bg), #ffffff);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(245,247,255,.78);
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .badge{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:900; color:white;
    }
    h1{font-size:18px; margin:0;}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:0; cursor:pointer;
      color:var(--text);
      background:var(--btn2);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 8px 18px rgba(2,6,23,.10);
      display:inline-flex; gap:8px; align-items:center;
      font-weight:800;
    }
    button.primary{color:white; background:linear-gradient(135deg, #2563eb, #4f46e5)}
    button.danger{color:white; background:linear-gradient(135deg, #e11d48, #fb7185)}
    button.ghost{background:transparent; border:1px solid rgba(15,23,42,.14); box-shadow:none}
    button:disabled{opacity:.45; cursor:not-allowed}
    .pill{
      border:1px solid rgba(15,23,42,.12);
      border-radius:999px;
      padding:8px 10px;
      color:var(--muted);
      font-size:12px;
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.7);
    }
    .pill strong{color:var(--text)}
    .grid{display:grid; grid-template-columns: 320px 1fr; gap:14px; padding:14px 16px 22px; max-width:1100px; margin:0 auto;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88));
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(15,23,42,.08);
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;
    }
    .card .hd .t{font-size:14px; font-weight:900}
    .card .hd .d{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.45}
    .card .bd{padding:14px}
    .progress{
      height:10px;
      background: rgba(15,23,42,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.08);
    }
    .progress > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, #22c55e, #2563eb);
      transition: width .35s ease;
    }
    .map{display:grid; gap:10px;}
    .stage{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px;
      border:1px solid rgba(15,23,42,.12);
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
    }
    .stage:hover{transform: translateY(-1px); background: rgba(255,255,255,.95)}
    .stage.active{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 10px 22px rgba(37,99,235,.12);
      background: rgba(37,99,235,.08);
    }
    .dot{
      width:12px; height:12px; border-radius:999px;
      background: rgba(15,23,42,.24);
      border:1px solid rgba(15,23,42,.18);
      position:relative;
    }
    .stage.done .dot{ background: var(--good); border-color: rgba(22,163,74,.45); }
    .stage.locked{ opacity:.55; cursor:not-allowed; }
    .stage .meta{display:flex; flex-direction:column; gap:3px}
    .stage .meta .name{font-weight:900; font-size:13px}
    .stage .meta .hint{font-size:12px; color:var(--muted)}
    .callout{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding:12px;
      background: rgba(255,255,255,.70);
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .callout strong{color:var(--text)}
    .toast{
      position:fixed; right:14px; bottom:14px; z-index:100;
      max-width: min(420px, calc(100vw - 28px));
      padding:12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: var(--shadow);
      display:none;
    }
    .toast.show{display:block; animation: pop .12s ease}
    @keyframes pop{ from{transform: translateY(6px); opacity:.0} to{transform: translateY(0); opacity:1} }
    .toast .row{display:flex; gap:10px; align-items:flex-start}
    .toast .icon{
      width:26px; height:26px; border-radius:10px;
      display:grid; place-items:center; flex:0 0 auto;
      background: rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.10);
    }
    .toast .msg{font-size:13px; line-height:1.45}
    .toast.good .icon{background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.25)}
    .toast.bad .icon{background: rgba(225,29,72,.12); border-color: rgba(225,29,72,.25)}
    .toast.warn .icon{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25)}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }
    .level-title{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:0 0 10px;}
    .level-title h2{margin:0; font-size:18px}
    .level-title .tag{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(15,23,42,.12);
      border-radius:999px;
      padding:6px 10px;
      background: rgba(255,255,255,.72);
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 12px;}
    .kpi .box{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.72);
      font-size:12px;
      color:var(--muted);
      display:flex; flex-direction:column; gap:4px;
    }
    .kpi .box strong{color:var(--text); font-size:16px; font-family:var(--mono)}
    .divider{ height:1px; background: rgba(15,23,42,.10); margin:12px 0; }
    .note{ font-size:12px; color:var(--muted); line-height:1.55; }
    .note strong{color:var(--text)}
    .panel{
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.72);
      padding:12px;
    }
    /* Drag & Drop */
    .dragRow{display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.90);
      cursor:grab;
      user-select:none;
      font-weight:900;
      font-size:13px;
    }
    .dropZone{
      min-height:52px;
      border-radius:16px;
      border:1px dashed rgba(15,23,42,.28);
      background: rgba(255,255,255,.68);
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .dropZone.good{border-color: rgba(22,163,74,.55); background: rgba(22,163,74,.10)}
    .dropZone.bad{border-color: rgba(225,29,72,.55); background: rgba(225,29,72,.08)}
    .dropZone .label{font-weight:900}
    .dropZone .slot{ color:var(--muted); font-size:12px; font-family:var(--mono); }
    /* Quiz */
    .qCard{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
      border-radius: 18px;
      padding:12px;
      margin:10px 0;
    }
    .qHead{ display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    .qHead .qid{font-family:var(--mono); color:var(--muted); font-size:12px}
    .qHead .qtxt{font-weight:900; font-size:14px; line-height:1.45; margin-top:4px}
    .opts{display:grid; gap:8px; margin-top:10px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease;
    }
    .opt:hover{transform: translateY(-1px); background: rgba(255,255,255,1)}
    .opt input{margin-top:3px}
    .feedback{
      margin-top:10px;
      border-radius: 14px;
      padding:10px;
      font-size:12px;
      line-height:1.55;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
      color:var(--muted);
    }
    .feedback.good{border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.10)}
    .feedback.bad{border-color: rgba(225,29,72,.30); background: rgba(225,29,72,.08)}
    .feedback .title{font-weight:900; color:var(--text); margin-bottom:4px}
    .inline{display:inline-flex; gap:8px; align-items:center; flex-wrap:wrap}
    .small{font-size:12px; color:var(--muted)}
    .mono{font-family:var(--mono)}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    /* Simple diagram */
    .diagram{
      display:grid; place-items:center;
      border-radius: 18px;
      padding:12px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      overflow:hidden;
    }
    .tip{
      display:none;
      margin-top:10px;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding:10px;
      background: rgba(255,255,255,.75);
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .tip.show{display:block}
    .tip strong{color:var(--text)}
    .hot{ cursor:pointer; filter: drop-shadow(0 8px 10px rgba(2,6,23,.10)); }
    /* Sort */
    .sortList{display:grid; gap:8px; margin-top:10px}
    .sortItem{
      display:flex; gap:10px; align-items:center;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.82);
      cursor:grab;
      user-select:none;
    }
    .handle{
      width:24px; height:24px; border-radius:10px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      display:grid; place-items:center;
      color:var(--muted); font-weight:900;
    }
    /* Level 2 flow */
    .flow{display:grid; gap:10px;}
    .tube{
      height:220px;
      border-radius: 24px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      position:relative;
      overflow:hidden;
    }
    .tube .node{
      position:absolute; left:14px; right:14px; height:48px;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      display:flex; justify-content:space-between; align-items:center;
      padding:0 12px;
      font-size:12px; color:var(--muted);
    }
    .node strong{color:var(--text)}
    .node.root{top:14px}
    .node.stem{top:86px}
    .node.leaf{top:158px}
    .droplet{
      position:absolute; width:16px; height:16px; border-radius:999px;
      background: linear-gradient(135deg, #22c55e, #2563eb);
      left: calc(50% - 8px);
      top: 26px;
      opacity:0;
    }
    /* Level 4 path */
    .pathGrid{ display:grid; gap:12px; }
    .pathBoard{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      padding:12px;
    }
    .nodes{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .n{
      padding:10px 10px; border-radius: 16px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      cursor:pointer; user-select:none;
      font-size:12px; color:var(--muted);
    }
    .n strong{color:var(--text)}
    .n.ok{border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.10)}
    .n.bad{border-color: rgba(225,29,72,.35); background: rgba(225,29,72,.08)}
    .token{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius: 16px; border:1px solid rgba(15,23,42,.12); background: rgba(255,255,255,.75); }
    .token .ball{ width:16px; height:16px; border-radius:999px; background: linear-gradient(135deg, #fb7185, #4f46e5); }
    .token .ball.oxygen{background: linear-gradient(135deg, #22c55e, #2563eb)}
    .token small{color:var(--muted)}
    /* Level 5 report */
    .report{ border:1px solid rgba(15,23,42,.10); border-radius: 18px; background: rgba(255,255,255,.72); padding:12px; }
    .tbl{ width:100%; border-collapse: collapse; margin-top:10px; font-size:12px; }
    .tbl th,.tbl td{ border-bottom:1px solid rgba(15,23,42,.10); padding:8px 6px; text-align:left; color:var(--muted); vertical-align:top; }
    .tbl th{color:var(--text); font-weight:900}
    .chipMini{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color:var(--muted); font-size:12px; margin-right:6px;
    }
    .chipMini.good{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10)}
    .chipMini.bad{border-color: rgba(225,29,72,.25); background: rgba(225,29,72,.08)}
    textarea{
      width:100%;
      border-radius:16px;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color:var(--text);
      outline:none;
      resize:vertical;
    }
    .footerSpace{height:24px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="badge">é‹</div>
        <div>
          <h1>ç”Ÿç‰©é«”å…§çš„é‹è¼¸ï½œäº”é—œå¡äº’å‹•éŠæˆ²ï¼ˆæ˜äº®ç‰ˆï¼‰</h1>
          <div class="sub">ç¬¬1~4é—œé€šé—œå„ +10 åˆ†ï½œç¬¬5é—œç¸½çµè©•é‡ + è¨ˆæ™‚åŠ æ¸›åˆ†ï½œç´”å‰ç«¯å–®æª”å¯é›¢ç·š</div>
        </div>
      </div>
      <div class="controls">
        <div class="pill" id="pillBest"><span>æœ€ä½³æˆç¸¾</span><strong id="bestScore">â€”</strong><span class="mono" id="bestDate"></span></div>
        <button class="ghost" id="btnSound" title="åˆ‡æ›éŸ³æ•ˆ">ğŸ”Š éŸ³æ•ˆï¼šé–‹</button>
        <button class="ghost" id="btnBack">â¬…ï¸ å›ä¸Šä¸€é—œ</button>
        <button class="primary" id="btnNext">â¡ï¸ ä¸‹ä¸€é—œ</button>
        <button class="danger" id="btnRestart">ğŸ” é‡æ–°é–‹å§‹</button>
      </div>
    </div>
    <div style="margin-top:12px;">
      <div class="progress"><div id="bar"></div></div>
    </div>
  </div>
</header>

<div class="grid">
  <!-- LEFT: map & status -->
  <div class="card">
    <div class="hd">
      <div>
        <div class="t">é—œå¡åœ°åœ–</div>
        <div class="d">å®Œæˆä¸€é—œæ‰å¯é€²ä¸‹ä¸€é—œï¼›å·²å®Œæˆæœƒæ‰“å‹¾ âœ…</div>
      </div>
      <div class="pill"><span>ç›®å‰</span><strong id="nowStage">1</strong><span>/ 5</span></div>
    </div>
    <div class="bd">
      <div class="map" id="map"></div>
      <div class="divider"></div>
      <div class="callout" id="sidebarTip">
        <strong>å°æé†’ï¼š</strong><br/>
        æ¯é¡Œä¸‹æ–¹éƒ½æœ‰ã€Œæç¤ºã€èˆ‡ã€Œè§£æã€ã€‚è«‹ç”¨è§£ææŠŠæ¦‚å¿µè¬›æ¸…æ¥šï¼š<br/>
        æ¤ç‰©ï¼šæœ¨è³ªéƒ¨ / éŸŒçš®éƒ¨ã€è’¸æ•£æ‹‰åŠ›ã€ä¾›æ‡‰éƒ¨â†’éœ€æ±‚éƒ¨ã€‚<br/>
        å‹•ç‰©ï¼šè¡€æ¶²å–®å‘ã€ç“£è†œé˜²é€†æµã€é«”å¾ªç’° / è‚ºå¾ªç’°èˆ‡ç‰©è³ªäº¤æ›ã€‚
      </div>
    </div>
  </div>

  <!-- RIGHT: level content -->
  <div class="card">
    <div class="hd">
      <div>
        <div class="t" id="levelName">ç¬¬1é—œï½œæ¤ç‰©çš„é‹è¼¸æ§‹é€ </div>
        <div class="d" id="levelDesc">æ‹–æ”¾é…å° + é»åœ–æ¨™è¨»ï¼šæŠŠæœ¨è³ªéƒ¨/éŸŒçš®éƒ¨æ”¾åˆ°æ­£ç¢ºä½ç½®ï¼Œä¸¦è®€æ‡‚å®ƒå€‘é‹è¼¸çš„ç‰©è³ªèˆ‡æ–¹å‘ã€‚</div>
      </div>
      <div class="pill" id="levelPill"><span>ç‹€æ…‹</span><strong id="levelStatus">é€²è¡Œä¸­</strong></div>
    </div>
    <div class="bd" id="levelRoot"><!-- injected --></div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="row">
    <div class="icon" id="toastIcon">â„¹ï¸</div>
    <div class="msg" id="toastMsg">è¨Šæ¯</div>
  </div>
</div>

<script>
/* ===========================
  ç”Ÿç‰©é«”å…§çš„é‹è¼¸ï½œå–®æª”éŠæˆ²ï¼ˆå¯é›¢ç·šï¼‰
  - å‰ 4 é—œï¼šé€šé—œå„ +10 åˆ†ï¼ˆå…± 40ï¼‰
  - ç¬¬ 5 é—œï¼š10 é¡Œæ··åˆé¡Œå‹ + è¨ˆæ™‚åŠ æ¸›åˆ†ï¼ˆÂ±10ï¼‰
  - æœ€çµ‚æ»¿åˆ† 150ï¼Œç­‰ç¬¬ A/B/C
=========================== */
(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  /* ---------- Sound (simple beep) ---------- */
  let soundOn = true;
  function beep(type="ok"){
    if(!soundOn) return;
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = type==="ok" ? 660 : type==="warn" ? 520 : 240;
      g.gain.value = 0.06;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 110);
    }catch(e){}
  }

  /* ---------- Toast ---------- */
  let toastTimer = null;
  function toast(msg, kind="warn"){
    const el = $("#toast");
    const ic = $("#toastIcon");
    const ms = $("#toastMsg");
    el.className = "toast show " + kind;
    ic.textContent = kind==="good" ? "âœ…" : kind==="bad" ? "â›”" : "â„¹ï¸";
    ms.textContent = msg;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> el.className = "toast", 2600);
    beep(kind==="good" ? "ok" : kind==="bad" ? "bad" : "warn");
  }

  /* ---------- Persistent best score ---------- */
  const BEST_KEY = "transport_game_best_bright_v1";
  function loadBest(){
    try{
      const raw = localStorage.getItem(BEST_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function saveBest(payload){
    try{ localStorage.setItem(BEST_KEY, JSON.stringify(payload)); }catch(e){}
  }
  function renderBest(){
    const best = loadBest();
    if(!best){
      $("#bestScore").textContent = "â€”";
      $("#bestDate").textContent = "";
      return;
    }
    $("#bestScore").textContent = best.total + " åˆ† (" + best.grade + ")";
    $("#bestDate").textContent = best.date ? "ï½œ" + best.date : "";
  }

  /* ---------- Game State ---------- */
  const state = {
    level: 1,
    completed: [false,false,false,false,false], // index 0..4
    passPoints: [0,0,0,0], // first 4 levels pass points (10 each if passed)
    level5: {
      started:false, startTs:null, timerId:null, secondsLeft:180,
      qAttempts:{}, qScore:{}, qWrong:{}, qDone:{},
      overtime:false, finished:false
    }
  };

  /* ---------- Stage definitions ---------- */
  const stages = [
    { id:1, name:"ç¬¬1é—œï½œæ¤ç‰©çš„é‹è¼¸æ§‹é€ ", hint:"æ‹–æ”¾é…å° + é»åœ–æ¨™è¨»", desc:"æŠŠã€Œæœ¨è³ªéƒ¨/éŸŒçš®éƒ¨ã€æ‹–åˆ°è–æ©«åˆ‡é¢æ­£ç¢ºä½ç½®ï¼Œä¸¦é»æ“Šåœ–ç¤ºé–±è®€æç¤ºã€‚"},
    { id:2, name:"ç¬¬2é—œï½œæ¤ç‰©çš„é‹è¼¸", hint:"è·¯å¾‘æ¨¡æ“¬ + æƒ…å¢ƒé¡Œ", desc:"ç”¨ã€Œè’¸æ•£ä½œç”¨ã€æ§åˆ¶éˆ•å•Ÿå‹•æ°´åˆ†é‹è¼¸ï¼Œä¸¦å›ç­”æƒ…å¢ƒé¡Œï¼šç¼ºè‘‰ï¼é™°å¤©ï¼æ°£å­”é—œé–‰çš„å½±éŸ¿ã€‚"},
    { id:3, name:"ç¬¬3é—œï½œå‹•ç‰©çš„é‹è¼¸æ§‹é€ ", hint:"æ’åº + é»æ“Šæ­ç¤º/é…å°", desc:"æ’åºè¡€ç®¡ç‰©è³ªäº¤æ›è·¯å¾‘ï¼Œä¸¦é…å°ç“£è†œåŠŸèƒ½ï¼Œç†è§£è¡€æ¶²å–®å‘æµå‹•ã€‚"},
    { id:4, name:"ç¬¬4é—œï½œå‹•ç‰©çš„é‹è¼¸", hint:"è·¯å¾‘ä»»å‹™ + ç‰©è³ªäº¤æ›", desc:"å®Œæˆé«”å¾ªç’°èˆ‡è‚ºå¾ªç’°çš„ã€Œè·¯å¾‘ä»»å‹™ã€ï¼Œä¸¦åœ¨äº¤æ›ç«™å›ç­”äº¤æ›ç‰©è³ªã€‚"},
    { id:5, name:"ç¬¬5é—œï½œé‹è¼¸å¤§æŒ‘æˆ°", hint:"æ··åˆé¡Œå‹ + è¨ˆæ™‚çµç®—", desc:"10 é¡Œç¸½çµè©•é‡ï¼ˆå–®é¸/å¤šé¸/æ‹–æ”¾/æ’åº/çŸ­ç­”ï¼‰ã€‚ä¾ä½œç­”æ¬¡æ•¸èˆ‡éŒ¯èª¤æ‰£åˆ†è¨ˆç®—ç¸½åˆ†èˆ‡ç­‰ç¬¬ã€‚"}
  ];

  /* ---------- Question Bank (Level 5) ---------- */
  const Q = [
    { id:"L5-01", type:"single",
      stem:"æ¤ç‰©ã€Œæœ¨è³ªéƒ¨ã€ä¸»è¦é‹è¼¸ä¸‹åˆ—å“ªä¸€é …ï¼Ÿæ–¹å‘é€šå¸¸å¦‚ä½•ï¼Ÿ",
      opts:[
        "é¤Šåˆ†ï¼ˆè”—ç³–ç­‰ï¼‰ä¸”ä¸€å®šå‘ä¸‹",
        "æ°´åˆ†èˆ‡ç„¡æ©Ÿé¹½ï¼Œé€šå¸¸ç”±æ ¹å‘ä¸Šåˆ°è‘‰",
        "æ°§æ°£ï¼Œå‘ä¸Šå‘ä¸‹éƒ½å¯",
        "äºŒæ°§åŒ–ç¢³ï¼Œé€šå¸¸ç”±è‘‰å‘æ ¹"
      ],
      ans:[1],
      hint:"æƒ³æƒ³ã€Œæ ¹å¸æ°´ â†’ è‘‰è’¸æ•£ã€çš„é€šé“æ˜¯èª°ã€‚",
      explain:"æœ¨è³ªéƒ¨ä¸»è¦è¼¸é€æ°´åˆ†èˆ‡ç„¡æ©Ÿé¹½ï¼Œå¤šæ•¸æƒ…æ³ç”±æ ¹å‘ä¸Šé‹è‡³è–ã€è‘‰ï¼›å…¶ä¸»è¦å‹•åŠ›å¯ç”±è’¸æ•£ä½œç”¨æä¾›å‘ä¸Šæ‹‰åŠ›ã€‚"
    },
    { id:"L5-02", type:"single",
      stem:"æ¤ç‰©ã€ŒéŸŒçš®éƒ¨ã€çš„é‹è¼¸ç‰¹è‰²æœ€ç¬¦åˆå“ªä¸€é …ï¼Ÿ",
      opts:[
        "åªèƒ½å‘ä¸Šï¼Œè¼¸é€æ°´åˆ†",
        "åªèƒ½å‘ä¸‹ï¼Œè¼¸é€ç„¡æ©Ÿé¹½",
        "å¯é›™å‘ï¼Œè¼¸é€é¤Šåˆ†ï¼ˆå¦‚è”—ç³–ï¼‰",
        "å¯é›™å‘ï¼Œè¼¸é€æ°§æ°£"
      ],
      ans:[2],
      hint:"éŸŒçš®éƒ¨è·Ÿã€Œä¾›æ‡‰éƒ¨â†’éœ€æ±‚éƒ¨ã€æœ‰é—œã€‚",
      explain:"éŸŒçš®éƒ¨ä¸»è¦é‹è¼¸æœ‰æ©Ÿé¤Šåˆ†ï¼ˆå¦‚è”—ç³–ï¼‰ï¼Œæ–¹å‘ä¾ä¾›æ‡‰éƒ¨ï¼ˆä¾†æºï¼‰èˆ‡éœ€æ±‚éƒ¨ï¼ˆå—é«”ï¼‰è€Œå®šï¼Œå› æ­¤å¯å‘ˆç¾é›™å‘æµå‹•ã€‚"
    },
    { id:"L5-03", type:"multi",
      stem:"ä¸‹åˆ—å“ªäº›æƒ…æ³æœƒè®“ã€Œæ¤ç‰©æ°´åˆ†å‘ä¸Šé‹è¼¸ã€çš„é€Ÿåº¦æ˜é¡¯è®Šæ…¢ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰",
      opts:[
        "é™°å¤©ï¼ˆå…‰å¼±ï¼Œæ°£å­”é–‹åº¦å¯èƒ½ä¸‹é™ï¼‰",
        "è‘‰ç‰‡å¤§é‡ç¼ºå¤±ï¼ˆè’¸æ•£é¢ç©æ¸›å°‘ï¼‰",
        "æ°£å­”é—œé–‰ï¼ˆè’¸æ•£ä¸‹é™ï¼‰",
        "é¢¨å¤§ç‚ç†±ï¼ˆè’¸æ•£å¢åŠ ï¼‰"
      ],
      ans:[0,1,2],
      hint:"è’¸æ•£æ‹‰åŠ›è¶Šå°ï¼Œå‘ä¸Šæ‹‰å¾—è¶Šæ…¢ã€‚",
      explain:"æ°´åˆ†å‘ä¸Šé‹è¼¸èˆ‡è’¸æ•£é€ æˆçš„æ‹‰åŠ›å¯†åˆ‡ç›¸é—œã€‚é™°å¤©ã€ç¼ºè‘‰ã€æ°£å­”é—œé–‰éƒ½æœƒé™ä½è’¸æ•£ï¼Œé€²è€Œä½¿æ°´åˆ†ä¸Šå‡é‹è¼¸è®Šæ…¢ï¼›é¢¨å¤§ç‚ç†±åè€Œå¸¸ä¿ƒé€²è’¸æ•£ã€‚"
    },
    { id:"L5-04", type:"dragmatch",
      stem:"æ‹–æ”¾é…å°ï¼šæŠŠã€Œæ§‹é€ ã€æ‹–åˆ°ã€Œæè¿°ã€æ­£ç¢ºä½ç½®ã€‚",
      pairs:[
        { left:"æœ¨è³ªéƒ¨", right:"é‹è¼¸æ°´åˆ†/ç„¡æ©Ÿé¹½ï¼Œå¸¸ç”±æ ¹å‘ä¸Š" },
        { left:"éŸŒçš®éƒ¨", right:"é‹è¼¸é¤Šåˆ†ï¼Œä¾ä¾›æ‡‰éƒ¨/éœ€æ±‚éƒ¨å¯é›™å‘" }
      ],
      hint:"ä¸€å€‹è·Ÿæ°´ã€è’¸æ•£æœ‰é—œï¼›ä¸€å€‹è·Ÿé¤Šåˆ†ã€Œä¾†æºâ†’å»å‘ã€æœ‰é—œã€‚",
      explain:"æœ¨è³ªéƒ¨è¼¸é€æ°´åˆ†/ç„¡æ©Ÿé¹½ï¼›éŸŒçš®éƒ¨è¼¸é€é¤Šåˆ†ä¸”å¯å› ä¾›æ‡‰éƒ¨/éœ€æ±‚éƒ¨è€Œå‘ˆé›™å‘ã€‚"
    },
    { id:"L5-05", type:"order",
      stem:"æ’åºé¡Œï¼šåœ¨ã€Œé«”å¾ªç’°ã€ä¸­ï¼Œå«æ°§è¡€å¾å¿ƒè‡Ÿå‡ºç™¼åˆ°å›åˆ°å¿ƒè‡Ÿçš„å…¸å‹è·¯å¾‘é †åºæ˜¯ï¼Ÿ",
      items:[
        "å·¦å¿ƒå®¤ â†’ ä¸»å‹•è„ˆ â†’ èº«é«”çµ„ç¹”å¾®è¡€ç®¡ï¼ˆç‰©è³ªäº¤æ›ï¼‰ â†’ éœè„ˆ â†’ å³å¿ƒæˆ¿",
        "å³å¿ƒå®¤ â†’ è‚ºå‹•è„ˆ â†’ è‚ºå¾®è¡€ç®¡ â†’ è‚ºéœè„ˆ â†’ å·¦å¿ƒæˆ¿",
        "å³å¿ƒæˆ¿ â†’ å·¦å¿ƒæˆ¿ â†’ ä¸»å‹•è„ˆ â†’ èº«é«”å¾®è¡€ç®¡ â†’ éœè„ˆ"
      ],
      correctIndex: 0,
      hint:"é«”å¾ªç’°æ˜¯ã€Œå¿ƒè‡Ÿ â†’ èº«é«” â†’ å¿ƒè‡Ÿã€ï¼Œå«æ°§è¡€èµ·é»åœ¨å·¦å¿ƒå®¤ã€‚",
      explain:"é«”å¾ªç’°ï¼šå·¦å¿ƒå®¤å°‡å«æ°§è¡€æ‰“å…¥ä¸»å‹•è„ˆâ†’èº«é«”å¾®è¡€ç®¡äº¤æ›â†’ç¶“éœè„ˆå›åˆ°å³å¿ƒæˆ¿ã€‚"
    },
    { id:"L5-06", type:"single",
      stem:"ç‚ºä»€éº¼å¿ƒè‡Ÿéœ€è¦ã€Œæˆ¿å®¤ç“£ã€èˆ‡ã€ŒåŠæœˆç“£ã€ï¼Ÿ",
      opts:[
        "è®“è¡€æ¶²é›™å‘æµå‹•ï¼Œæ–¹ä¾¿æ··åˆ",
        "é¿å…è¡€æ¶²é€†æµï¼Œç¶­æŒå–®å‘æµå‹•",
        "å¢åŠ è¡€æ¶²ä¸­çš„é¤Šåˆ†æ¿ƒåº¦",
        "è®“è¡€æ¶²åœ¨å¿ƒè‡Ÿä¸­åœç•™æ›´ä¹…"
      ],
      ans:[1],
      hint:"é¡Œç›®é—œéµå­—ï¼šå–®å‘ã€é€†æµã€‚",
      explain:"æˆ¿å®¤ç“£èˆ‡åŠæœˆç“£çš„ä¸»è¦åŠŸèƒ½æ˜¯é˜²æ­¢è¡€æ¶²é€†æµï¼Œç¢ºä¿è¡€æ¶²åœ¨å¿ƒè‡Ÿèˆ‡è¡€ç®¡ä¸­ç¶­æŒå–®å‘æµå‹•ã€‚"
    },
    { id:"L5-07", type:"single",
      stem:"ä¸‹åˆ—å“ªä¸€é …æœ€èƒ½æè¿°ã€Œè‚ºå¾ªç’°ã€ï¼Ÿ",
      opts:[
        "å·¦å¿ƒå®¤ â†’ èº«é«” â†’ å³å¿ƒæˆ¿",
        "å³å¿ƒå®¤ â†’ è‚º â†’ å·¦å¿ƒæˆ¿",
        "å·¦å¿ƒæˆ¿ â†’ è‚º â†’ å³å¿ƒå®¤",
        "å³å¿ƒæˆ¿ â†’ èº«é«” â†’ å·¦å¿ƒå®¤"
      ],
      ans:[1],
      hint:"è‚ºå¾ªç’°ï¼šæŠŠç¼ºæ°§è¡€é€åˆ°è‚ºæ›æ°£ï¼Œå†æŠŠå«æ°§è¡€é€å›å¿ƒè‡Ÿã€‚",
      explain:"è‚ºå¾ªç’°ï¼šå³å¿ƒå®¤å°‡ç¼ºæ°§è¡€é€å…¥è‚ºå‹•è„ˆâ†’è‚ºå¾®è¡€ç®¡é€²è¡Œæ°£é«”äº¤æ›â†’ç¶“è‚ºéœè„ˆå›åˆ°å·¦å¿ƒæˆ¿ã€‚"
    },
    { id:"L5-08", type:"multi",
      stem:"é—œæ–¼ã€Œç‰©è³ªäº¤æ›ã€æ­£ç¢ºçš„æ˜¯å“ªäº›ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰",
      opts:[
        "èº«é«”çµ„ç¹”ï¼šæ°§æ°£é€²å…¥ç´°èƒã€äºŒæ°§åŒ–ç¢³é€²å…¥è¡€æ¶²",
        "è‚ºæ³¡ï¼šäºŒæ°§åŒ–ç¢³é€²å…¥è¡€æ¶²ã€æ°§æ°£é€²å…¥è‚ºæ³¡",
        "è‚ºæ³¡ï¼šæ°§æ°£é€²å…¥è¡€æ¶²ã€äºŒæ°§åŒ–ç¢³é›¢é–‹è¡€æ¶²",
        "èº«é«”çµ„ç¹”ï¼šé¤Šåˆ†èˆ‡æ°§æ°£é€šå¸¸å¾è¡€æ¶²æ“´æ•£åˆ°ç´°èƒ"
      ],
      ans:[0,2,3],
      hint:"æŠŠäº¤æ›ç«™åˆ†æˆã€Œèº«é«”çµ„ç¹”ã€èˆ‡ã€Œè‚ºæ³¡ã€å…©ç¨®ã€‚",
      explain:"èº«é«”çµ„ç¹”äº¤æ›ï¼šæ°§æ°£/é¤Šåˆ†ç”±è¡€åˆ°ç´°èƒï¼ŒäºŒæ°§åŒ–ç¢³ç”±ç´°èƒåˆ°è¡€ã€‚è‚ºæ³¡äº¤æ›ï¼šæ°§æ°£ç”±è‚ºæ³¡åˆ°è¡€ï¼ŒäºŒæ°§åŒ–ç¢³ç”±è¡€åˆ°è‚ºæ³¡ä¸¦å‘¼å‡ºã€‚"
    },
    { id:"L5-09", type:"short",
      stem:"çŸ­ç­” 1ï¼šç”¨ 1~2 å¥è©±èªªæ˜ã€Œæ¤ç‰©æ°´åˆ†å‘ä¸Šé‹è¼¸ã€æœ€ä¸»è¦çš„é©…å‹•åŠ›æ˜¯ä»€éº¼ï¼Ÿï¼ˆè«‹åŒ…å«é—œéµè©ï¼‰",
      keywords:["è’¸æ•£","æ‹‰åŠ›"],
      hint:"è«‹å¯«åˆ°ï¼šè‘‰çš„è’¸æ•£ + å‘ä¸Šæ‹‰åŠ›ï¼ˆå¯è£œå……æ¯›ç´°/æ ¹å£“ï¼‰ã€‚",
      explain:"ä¸»è¦é©…å‹•åŠ›æ˜¯è‘‰ç‰‡è’¸æ•£é€ æˆçš„å‘ä¸Šæ‹‰åŠ›ï¼ˆç‰½å¼•æ°´æŸ±ä¸Šå‡ï¼‰ï¼›å¯è£œå……æ¯›ç´°ä½œç”¨èˆ‡æ ¹å£“ä½œç‚ºå”åŠ©å› ç´ ã€‚"
    },
    { id:"L5-10", type:"short",
      stem:"çŸ­ç­” 2ï¼šç”¨ 1~2 å¥è©±èªªæ˜ã€ŒéŸŒçš®éƒ¨ç‚ºä½•å¯èƒ½å‘ˆç¾é›™å‘é‹è¼¸ã€ï¼Ÿï¼ˆè«‹åŒ…å«é—œéµè©ï¼‰",
      keywords:["ä¾›æ‡‰éƒ¨","éœ€æ±‚éƒ¨"],
      hint:"å¯«åˆ°ï¼šä¾†æºï¼ˆä¾›æ‡‰ï¼‰èˆ‡å»å‘ï¼ˆéœ€æ±‚ï¼‰æœƒæ”¹è®Šæµå‹•æ–¹å‘ã€‚",
      explain:"éŸŒçš®éƒ¨è¼¸é€é¤Šåˆ†çš„æ–¹å‘å–æ±ºæ–¼ä¾›æ‡‰éƒ¨ï¼ˆä¾†æºï¼‰èˆ‡éœ€æ±‚éƒ¨ï¼ˆå—é«”ï¼‰çš„ç›¸å°ä½ç½®èˆ‡éœ€æ±‚ï¼Œå› æ­¤å¯èƒ½å‘ä¸Šæˆ–å‘ä¸‹ï¼Œå‘ˆç¾é›™å‘ã€‚"
    }
  ];

  /* ---------- Helpers ---------- */
  const clamp = (n,a,b)=>Math.max(a, Math.min(b, n));
  function formatTime(sec){
    const s = Math.abs(sec);
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(Math.floor(s%60)).padStart(2,"0");
    return (sec < 0 ? "-" : "") + mm + ":" + ss;
  }
  function gradeOf(total){ if(total>=130) return "A"; if(total>=100) return "B"; return "C"; }
  function baseScoreByAttempts(at){ if(at===1) return 10; if(at===2) return 6; if(at===3) return 3; return 0; }

  /* ---------- Map & navigation ---------- */
  function canEnterStage(stageId){
    if(stageId===1) return true;
    return state.completed[stageId-2] === true;
  }
  function renderMap(){
    const map = $("#map");
    map.innerHTML = "";
    stages.forEach(s=>{
      const div = document.createElement("div");
      const locked = !canEnterStage(s.id);
      div.className = "stage" + (state.level===s.id ? " active":"") + (state.completed[s.id-1] ? " done":"") + (locked ? " locked":"");
      div.innerHTML = `
        <div class="dot"></div>
        <div class="meta">
          <div class="name">${s.name}</div>
          <div class="hint">${s.hint}</div>
        </div>
        <div style="margin-left:auto;color:var(--muted);font-size:12px;">
          ${state.completed[s.id-1] ? "âœ…" : locked ? "ğŸ”’" : "â–¶"}
        </div>
      `;
      div.addEventListener("click", ()=>{
        if(locked){ toast("éœ€è¦å…ˆå®Œæˆå‰ä¸€é—œæ‰èƒ½é€²å…¥ã€‚", "warn"); return; }
        goToLevel(s.id);
      });
      map.appendChild(div);
    });
    $("#nowStage").textContent = String(state.level);
    const pct = (state.completed.filter(Boolean).length / 5) * 100;
    $("#bar").style.width = pct + "%";
  }
  function updateHeaderButtons(){
    $("#btnBack").disabled = state.level===1;
    const isLast = state.level===5;
    const currDone = state.completed[state.level-1];
    $("#btnNext").disabled = isLast ? true : !currDone;
  }
  function setLevelStatus(){
    $("#levelStatus").textContent = state.completed[state.level-1] ? "å·²å®Œæˆ âœ…" : "é€²è¡Œä¸­";
  }

  function goToLevel(n){
    state.level = n;
    renderLevel();
    renderMap();
    updateHeaderButtons();
    setLevelStatus();
  }

  $("#btnBack").addEventListener("click", ()=>{ if(state.level>1) goToLevel(state.level-1); });
  $("#btnNext").addEventListener("click", ()=>{
    if(state.level>=5) return;
    if(!state.completed[state.level-1]){ toast("å…ˆå®Œæˆæœ¬é—œå†å‰å¾€ä¸‹ä¸€é—œã€‚", "warn"); return; }
    goToLevel(state.level+1);
  });
  $("#btnSound").addEventListener("click", ()=>{
    soundOn = !soundOn;
    $("#btnSound").textContent = soundOn ? "ğŸ”Š éŸ³æ•ˆï¼šé–‹" : "ğŸ”‡ éŸ³æ•ˆï¼šé—œ";
    toast(soundOn ? "éŸ³æ•ˆå·²é–‹å•Ÿ" : "éŸ³æ•ˆå·²é—œé–‰", "good");
  });
  $("#btnRestart").addEventListener("click", ()=>{
    if(!confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿç¬¬5é—œä½œç­”èˆ‡è¨ˆæ™‚å°‡æœƒæ¸…ç©ºã€‚")) return;
    stopLevel5Timer();
    state.level = 1;
    state.completed = [false,false,false,false,false];
    state.passPoints = [0,0,0,0];
    state.level5 = { started:false, startTs:null, timerId:null, secondsLeft:180, qAttempts:{}, qScore:{}, qWrong:{}, qDone:{}, overtime:false, finished:false };
    renderLevel();
    renderMap();
    updateHeaderButtons();
    setLevelStatus();
    toast("å·²é‡æ–°é–‹å§‹ã€‚å¾ç¬¬ 1 é—œå‡ºç™¼ï¼", "good");
  });

  /* ---------- Level renderer ---------- */
  function renderLevel(){
    const s = stages[state.level-1];
    $("#levelName").textContent = s.name;
    $("#levelDesc").textContent = s.desc;
    const root = $("#levelRoot");
    root.innerHTML = "";
    if(state.level===1) renderLevel1(root);
    if(state.level===2) renderLevel2(root);
    if(state.level===3) renderLevel3(root);
    if(state.level===4) renderLevel4(root);
    if(state.level===5) renderLevel5(root);
    setLevelStatus();
  }

  /* =========================================
     LEVEL 1: Plant structure
  ========================================= */
  function renderLevel1(root){
    root.innerHTML = `
      <div class="level-title">
        <h2>ç¬¬1é—œï½œæ¤ç‰©çš„é‹è¼¸æ§‹é€ </h2>
        <span class="tag">æ‹–æ”¾é…å°</span>
        <span class="tag">é»åœ–æ¨™è¨»</span>
      </div>

      <div class="kpi">
        <div class="box"><span>æœ¬é—œé€šé—œåˆ†</span><strong class="mono">+10</strong></div>
        <div class="box"><span>ä»»å‹™</span><strong class="mono">2</strong><span class="small">æœ¨è³ªéƒ¨ / éŸŒçš®éƒ¨é…å°</span></div>
      </div>

      <div class="split">
        <div class="panel">
          <div class="note">
            <strong>ä»»å‹™ 1ï½œæ‹–æ”¾é…å°ï¼š</strong>æŠŠã€Œæœ¨è³ªéƒ¨ã€ã€ŒéŸŒçš®éƒ¨ã€æ‹–åˆ°è–æ©«åˆ‡é¢çš„æ­£ç¢ºä½ç½®ã€‚<br/>
            <span class="small">æç¤ºï¼šæœ¨è³ªéƒ¨åå…§ã€éŸŒçš®éƒ¨åå¤–ï¼›æœ¨è³ªéƒ¨å¤šé‹æ°´åˆ†/ç„¡æ©Ÿé¹½ï¼ŒéŸŒçš®éƒ¨å¤šé‹é¤Šåˆ†ä¸”å¯é›™å‘ã€‚</span>
          </div>

          <div style="margin-top:12px;" class="dragRow">
            <div class="chip" draggable="true" data-drag="æœ¨è³ªéƒ¨">æœ¨è³ªéƒ¨</div>
            <div class="chip" draggable="true" data-drag="éŸŒçš®éƒ¨">éŸŒçš®éƒ¨</div>
          </div>

          <div style="margin-top:12px; display:grid; gap:10px;">
            <div class="dropZone" data-zone="outer">
              <div class="label">å¤–å´ï¼ˆé è¿‘è¡¨çš®ï¼‰</div>
              <div class="slot">æ‹–åˆ°é€™è£¡</div>
            </div>
            <div class="dropZone" data-zone="inner">
              <div class="label">å…§å´ï¼ˆé è¿‘é«“éƒ¨ï¼‰</div>
              <div class="slot">æ‹–åˆ°é€™è£¡</div>
            </div>
          </div>

          <div class="rowBtns">
            <button class="ghost" id="l1Check">âœ… æª¢æŸ¥é…å°</button>
            <button class="ghost" id="l1Reset">ğŸ§½ æ¸…é™¤é‡ä¾†</button>
          </div>

          <div class="feedback" id="l1Fb" style="display:none;"></div>
        </div>

        <div class="panel">
          <div class="note">
            <strong>ä»»å‹™ 2ï½œé»åœ–æ¨™è¨»ï¼š</strong>é»æ“Šåœ–ä¸­çš„å°åœ–ç¤ºï¼Œè®€æ‡‚æœ¨è³ªéƒ¨/éŸŒçš®éƒ¨çš„åŠŸèƒ½èˆ‡é‹è¼¸æ–¹å‘ã€‚
          </div>

          <div class="diagram" style="margin-top:12px;">
            <svg viewBox="0 0 320 260" width="100%" height="240" aria-label="stem diagram">
              <defs>
                <radialGradient id="g1" cx="50%" cy="40%" r="70%">
                  <stop offset="0%" stop-color="rgba(37,99,235,.18)"></stop>
                  <stop offset="100%" stop-color="rgba(37,99,235,.04)"></stop>
                </radialGradient>
                <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="rgba(34,197,94,.55)"></stop>
                  <stop offset="100%" stop-color="rgba(37,99,235,.45)"></stop>
                </linearGradient>
              </defs>

              <!-- stem cross section -->
              <circle cx="160" cy="125" r="92" fill="url(#g1)" stroke="rgba(15,23,42,.14)" stroke-width="2"></circle>
              <circle cx="160" cy="125" r="58" fill="rgba(15,23,42,.03)" stroke="rgba(15,23,42,.10)" stroke-width="2"></circle>

              <!-- inner core -->
              <circle cx="160" cy="125" r="38" fill="rgba(37,99,235,.10)" stroke="rgba(37,99,235,.22)" stroke-width="2"></circle>

              <!-- hotspots -->
              <g class="hot" data-hot="phloem">
                <circle cx="240" cy="86" r="12" fill="url(#g2)" stroke="rgba(15,23,42,.18)" stroke-width="2"></circle>
                <text x="240" y="91" text-anchor="middle" font-size="12" fill="#0f172a" font-weight="900">i</text>
              </g>
              <g class="hot" data-hot="xylem">
                <circle cx="160" cy="125" r="12" fill="rgba(225,29,72,.35)" stroke="rgba(15,23,42,.18)" stroke-width="2"></circle>
                <text x="160" y="130" text-anchor="middle" font-size="12" fill="#0f172a" font-weight="900">i</text>
              </g>

              <text x="160" y="245" text-anchor="middle" font-size="12" fill="rgba(15,23,42,.55)">ï¼ˆç¤ºæ„åœ–ï¼šå¤–åœˆèˆ‡å…§åœˆä½ç½®æ¦‚å¿µï¼‰</text>
            </svg>
          </div>

          <div class="tip" id="l1Tip"></div>

          <div class="divider"></div>

          <div class="note">
            <strong>é€šé—œæ¢ä»¶ï¼š</strong>æ‹–æ”¾é…å°æ­£ç¢º + è®€å®Œæç¤ºå¾ŒæŒ‰ã€Œå®Œæˆæœ¬é—œã€ã€‚
          </div>

          <div class="rowBtns">
            <button class="primary" id="l1Finish" disabled>ğŸ å®Œæˆæœ¬é—œï¼ˆ+10ï¼‰</button>
          </div>
        </div>
      </div>
    `;

    const placed = { outer:null, inner:null };
    const zones = $$(".dropZone", root);
    const chips = $$(".chip", root);

    chips.forEach(ch=>{
      ch.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", ch.dataset.drag);
      });
    });

    zones.forEach(z=>{
      z.addEventListener("dragover", e=>e.preventDefault());
      z.addEventListener("drop", (e)=>{
        e.preventDefault();
        const val = e.dataTransfer.getData("text/plain");
        const zone = z.dataset.zone;
        placed[zone] = val;
        z.querySelector(".slot").textContent = val ? ("å·²æ”¾å…¥ï¼š" + val) : "æ‹–åˆ°é€™è£¡";
        toast(`å·²æ”¾å…¥ï¼š${val}`, "good");
      });
    });

    $("#l1Reset", root).addEventListener("click", ()=>{
      placed.outer = null; placed.inner = null;
      zones.forEach(z=>{
        z.classList.remove("good","bad");
        z.querySelector(".slot").textContent = "æ‹–åˆ°é€™è£¡";
      });
      $("#l1Fb", root).style.display="none";
      $("#l1Finish", root).disabled = true;
      toast("å·²æ¸…é™¤ï¼Œé‡æ–°é…å°ã€‚","warn");
    });

    const tipsRead = { xylem:false, phloem:false };
    $$(".hot", root).forEach(h=>{
      h.addEventListener("click", ()=>{
        const t = h.dataset.hot;
        const box = $("#l1Tip", root);
        box.classList.add("show");
        if(t==="xylem"){
          tipsRead.xylem = true;
          box.innerHTML = `
            <strong>æœ¨è³ªéƒ¨ï¼ˆXylemï¼‰</strong><br/>
            ä¸»è¦é‹è¼¸ <strong>æ°´åˆ†èˆ‡ç„¡æ©Ÿé¹½</strong>ï¼Œå¤šç”± <strong>æ ¹ â†’ è– â†’ è‘‰</strong> å‘ä¸Šé‹é€ã€‚<br/>
            æ°´åˆ†å‘ä¸Šé‹è¼¸å¸¸èˆ‡ <strong>è’¸æ•£ä½œç”¨é€ æˆçš„æ‹‰åŠ›</strong> å¯†åˆ‡ç›¸é—œï¼ˆå¯æ­é…æ¯›ç´°ä½œç”¨/æ ¹å£“ç†è§£ï¼‰ã€‚
          `;
        }else{
          tipsRead.phloem = true;
          box.innerHTML = `
            <strong>éŸŒçš®éƒ¨ï¼ˆPhloemï¼‰</strong><br/>
            ä¸»è¦é‹è¼¸ <strong>é¤Šåˆ†ï¼ˆå¦‚è”—ç³–ï¼‰</strong>ï¼Œæ–¹å‘ä¾ <strong>ä¾›æ‡‰éƒ¨ï¼ˆä¾†æºï¼‰</strong> èˆ‡ <strong>éœ€æ±‚éƒ¨ï¼ˆå—é«”ï¼‰</strong> æ±ºå®šï¼Œå› æ­¤å¯èƒ½å‘ˆç¾ <strong>é›™å‘</strong>ã€‚
          `;
        }
        maybeEnableFinish();
      });
    });

    function check(){
      const fb = $("#l1Fb", root);
      fb.style.display="block";
      zones.forEach(z=>z.classList.remove("good","bad"));

      const okOuter = placed.outer === "éŸŒçš®éƒ¨";
      const okInner = placed.inner === "æœ¨è³ªéƒ¨";

      const outerEl = $('.dropZone[data-zone="outer"]', root);
      const innerEl = $('.dropZone[data-zone="inner"]', root);
      outerEl.classList.add(okOuter ? "good" : "bad");
      innerEl.classList.add(okInner ? "good" : "bad");

      const ok = okOuter && okInner;
      fb.className = "feedback " + (ok ? "good" : "bad");
      fb.innerHTML = `
        <div class="title">${ok ? "âœ… é…å°æ­£ç¢ºï¼" : "â›” é‚„å·®ä¸€é»ï¼"}</div>
        <div>${ok ? "ä½ å·²æ­£ç¢ºè¾¨è­˜ï¼šéŸŒçš®éƒ¨åå¤–ã€æœ¨è³ªéƒ¨åå…§ã€‚" : "è«‹å†æƒ³æƒ³ï¼šæœ¨è³ªéƒ¨é€šå¸¸æ›´é å…§ï¼›éŸŒçš®éƒ¨æ›´é å¤–ã€‚"}</div>
        <div class="small" style="margin-top:6px;">
          è§£æï¼šæœ¨è³ªéƒ¨å¤šé‹è¼¸æ°´åˆ†/ç„¡æ©Ÿé¹½ï¼ˆå¸¸å‘ä¸Šï¼‰ï¼ŒéŸŒçš®éƒ¨é‹è¼¸é¤Šåˆ†ï¼Œæ–¹å‘ä¾ä¾›æ‡‰éƒ¨/éœ€æ±‚éƒ¨è€Œå¯é›™å‘ã€‚
        </div>
      `;
      toast(ok ? "é…å°æˆåŠŸï¼å†å®Œæˆé»åœ–é–±è®€å³å¯é€šé—œã€‚" : "å†èª¿æ•´ä¸€ä¸‹é…å°ä½ç½®ã€‚", ok ? "good" : "bad");
      maybeEnableFinish();
    }

    function maybeEnableFinish(){
      const okMatch = (placed.outer === "éŸŒçš®éƒ¨") && (placed.inner === "æœ¨è³ªéƒ¨");
      const okTips = tipsRead.xylem && tipsRead.phloem;
      $("#l1Finish", root).disabled = !(okMatch && okTips);
    }

    $("#l1Check", root).addEventListener("click", check);

    $("#l1Finish", root).addEventListener("click", ()=>{
      state.completed[0] = true;
      state.passPoints[0] = 10;
      renderMap(); updateHeaderButtons(); setLevelStatus();
      toast("ç¬¬ 1 é—œé€šé—œï¼ç²å¾— +10 åˆ†ã€‚","good");
    });
  }

  /* =========================================
     LEVEL 2: Plant transport
  ========================================= */
  function renderLevel2(root){
    root.innerHTML = `
      <div class="level-title">
        <h2>ç¬¬2é—œï½œæ¤ç‰©çš„é‹è¼¸</h2>
        <span class="tag">è·¯å¾‘æ¨¡æ“¬</span>
        <span class="tag">æƒ…å¢ƒé¡Œ</span>
      </div>

      <div class="kpi">
        <div class="box"><span>æœ¬é—œé€šé—œåˆ†</span><strong class="mono">+10</strong></div>
        <div class="box"><span>ä»»å‹™</span><strong class="mono">3</strong><span class="small">æ¨¡æ“¬ 1 æ¬¡ + æƒ…å¢ƒé¡Œ 2 é¡Œ</span></div>
      </div>

      <div class="split">
        <div class="panel">
          <div class="note">
            <strong>ä»»å‹™ 1ï½œæ°´åˆ†é‹è¼¸æ¨¡æ“¬ï¼š</strong>æŒ‰ã€Œé–‹å§‹é‹è¼¸ã€å¾Œï¼Œæ°´æ»´æœƒå¾æ ¹éƒ¨å¾€ä¸Šåˆ°è‘‰ã€‚<br/>
            <span class="small">è«‹ç”¨æ»‘æ¡¿èª¿æ•´ã€Œè’¸æ•£å¼·åº¦ã€ï¼šè’¸æ•£è¶Šå¼·ï¼Œå‘ä¸Šæ‹‰åŠ›è¶Šå¤§ï¼Œæ°´æ»´è¶Šå¿«ä¸Šå‡ã€‚</span>
          </div>

          <div class="flow" style="margin-top:12px;">
            <div class="tube" id="tube">
              <div class="node root"><strong>æ ¹</strong><span>å¸æ”¶æ°´åˆ†/ç„¡æ©Ÿé¹½</span></div>
              <div class="node stem"><strong>è–</strong><span>æœ¨è³ªéƒ¨å‘ä¸Šé‹è¼¸</span></div>
              <div class="node leaf"><strong>è‘‰</strong><span>è’¸æ•£ä½œç”¨ï¼šæ‹‰åŠ›ä¾†æº</span></div>
              <div class="droplet" id="drop"></div>
            </div>

            <div class="panel" style="padding:10px;">
              <div class="inline">
                <label class="small"><strong>è’¸æ•£å¼·åº¦</strong>ï¼ˆå¼±â†’å¼·ï¼‰</label>
                <input type="range" id="tran" min="1" max="10" value="6" />
                <span class="pill"><span>é€Ÿåº¦</span><strong id="spd" class="mono">6</strong></span>
              </div>

              <div class="small" style="margin-top:8px;">
                å¿«é€Ÿç†è§£ï¼šè’¸æ•£è¶Šå¼· â†’ å‘ä¸Šæ‹‰åŠ›è¶Šå¤§ â†’ æ°´åˆ†ä¸Šå‡è¶Šæ˜é¡¯ï¼ˆå¯è£œå……æ¯›ç´°ä½œç”¨ã€æ ¹å£“åšå”åŠ©å› ç´ ï¼‰ã€‚
              </div>

              <div class="rowBtns" style="margin-top:10px;">
                <button class="primary" id="simGo">â–¶ï¸ é–‹å§‹é‹è¼¸</button>
                <button class="ghost" id="simStop">â¹ åœæ­¢</button>
              </div>

              <div class="feedback" id="simFb" style="display:none;"></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="note">
            <strong>ä»»å‹™ 2~3ï½œæƒ…å¢ƒé¡Œï¼š</strong>è«‹æŠŠã€Œè’¸æ•£æ‹‰åŠ›ã€èˆ‡ã€Œé‹è¼¸é€Ÿåº¦ã€é€£èµ·ä¾†æ€è€ƒã€‚
          </div>

          <div class="qCard" id="l2q1"></div>
          <div class="qCard" id="l2q2"></div>

          <div class="rowBtns">
            <button class="ghost" id="l2Check">âœ… æª¢æŸ¥æƒ…å¢ƒé¡Œ</button>
          </div>

          <div class="feedback" id="l2Fb" style="display:none;"></div>

          <div class="divider"></div>

          <div class="note"><strong>é€šé—œæ¢ä»¶ï¼š</strong>å®Œæˆæ¨¡æ“¬è‡³å°‘ 1 æ¬¡ + æƒ…å¢ƒé¡Œå…©é¡Œçš†æ­£ç¢ºã€‚</div>

          <div class="rowBtns">
            <button class="primary" id="l2Finish" disabled>ğŸ å®Œæˆæœ¬é—œï¼ˆ+10ï¼‰</button>
          </div>
        </div>
      </div>
    `;

    const tran = $("#tran", root);
    const spd = $("#spd", root);
    let simRan = false;
    let simTimer = null;

    function setSpeed(){ spd.textContent = String(tran.value); }
    tran.addEventListener("input", setSpeed);
    setSpeed();

    const drop = $("#drop", root);

    function simStart(){
      clearInterval(simTimer);
      simRan = true;
      const v = Number(tran.value);
      let y = 26; // top px
      drop.style.opacity = 1;
      drop.style.top = y + "px";
      $("#simFb", root).style.display="none";
      toast("æ¨¡æ“¬é–‹å§‹ï¼šè§€å¯Ÿæ°´æ»´å¦‚ä½•ä¸Šå‡ã€‚","good");

      simTimer = setInterval(()=>{
        y += (0.7 + v*0.55); // speed
        drop.style.top = y + "px";
        if(y >= 176){
          clearInterval(simTimer);
          const fb = $("#simFb", root);
          fb.style.display="block";
          fb.className = "feedback good";
          fb.innerHTML = `
            <div class="title">âœ… æ¨¡æ“¬å®Œæˆï¼šæ°´åˆ†åˆ°é”è‘‰</div>
            <div>è§£æï¼šæ¤ç‰©æ°´åˆ†ä¸»è¦ç¶“ <strong>æœ¨è³ªéƒ¨</strong> ä¸Šå‡ï¼›<strong>è’¸æ•£ä½œç”¨</strong>å¯é€ æˆå‘ä¸Šæ‹‰åŠ›ï¼Œä¿ƒé€²æ°´åˆ†æŒçºŒè¢«æ‹‰ä¸Šä¾†ã€‚</div>
          `;
          maybeEnableFinish();
        }
      }, 35);
    }

    function simStop(){
      clearInterval(simTimer);
      const fb = $("#simFb", root);
      fb.style.display="block";
      fb.className = "feedback";
      fb.innerHTML = `
        <div class="title">â¸ å·²åœæ­¢</div>
        <div>ä½ å¯ä»¥èª¿æ•´ã€Œè’¸æ•£å¼·åº¦ã€å†é‡æ–°é–‹å§‹ï¼Œæ¯”è¼ƒé€Ÿåº¦å·®ç•°ã€‚</div>
      `;
    }

    $("#simGo", root).addEventListener("click", simStart);
    $("#simStop", root).addEventListener("click", simStop);

    const q1 = {
      id:"L2Q1", type:"single",
      stem:"æƒ…å¢ƒ 1ï¼šè‹¥æ¤ç‰©ã€Œè‘‰ç‰‡å¤§é‡ç¼ºå¤±ã€ï¼Œæ°´åˆ†å‘ä¸Šé‹è¼¸é€šå¸¸æœƒå¦‚ä½•æ”¹è®Šï¼Ÿ",
      opts:["è®Šå¿«ï¼ˆå› ç‚ºé˜»åŠ›è®Šå°ï¼‰","è®Šæ…¢ï¼ˆå› ç‚ºè’¸æ•£é¢ç©æ¸›å°‘ï¼‰","ä¸è®Šï¼ˆè’¸æ•£èˆ‡é‹è¼¸ç„¡é—œï¼‰","ä¸€å®šåœæ­¢ï¼ˆæ ¹ä¸å†å¸æ°´ï¼‰"],
      ans: 1,
      hint:"è‘‰å°‘ â†’ è’¸æ•£å°‘ â†’ æ‹‰åŠ›å°ã€‚",
      explain:"è‘‰ç‰‡æ¸›å°‘ä½¿è’¸æ•£é¢ç©ä¸‹é™ï¼Œè’¸æ•£é€ æˆçš„æ‹‰åŠ›æ¸›å¼±ï¼Œå› æ­¤æ°´åˆ†ä¸Šå‡é‹è¼¸å¾€å¾€è®Šæ…¢ã€‚"
    };
    const q2 = {
      id:"L2Q2", type:"multi",
      stem:"æƒ…å¢ƒ 2ï¼šå“ªäº›ç‹€æ³æœƒä½¿è’¸æ•£ä¸‹é™ï¼Œé€²è€Œè®“æ°´åˆ†å‘ä¸Šé‹è¼¸è®Šæ…¢ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰",
      opts:["é™°å¤©","æ°£å­”é—œé–‰","é¢¨å¤§ç‚ç†±","è‘‰ç‰‡å¤§é‡ç¼ºå¤±"],
      ans: [0,1,3],
      hint:"æŠ“ä½ï¼šè’¸æ•£â†“ çš„æƒ…æ³ã€‚",
      explain:"é™°å¤©ã€æ°£å­”é—œé–‰ã€è‘‰ç‰‡ç¼ºå¤±éƒ½æœƒé™ä½è’¸æ•£ï¼›é¢¨å¤§ç‚ç†±å¸¸å¢åŠ è’¸æ•£ã€‚"
    };

    function renderScenario(containerId, q){
      const box = $("#" + containerId, root);
      const multi = q.type === "multi";
      box.innerHTML = `
        <div class="qHead">
          <div>
            <div class="qid">${q.id}</div>
            <div class="qtxt">${q.stem}</div>
          </div>
          <div class="pill"><span>${multi ? "å¤šé¸" : "å–®é¸"}</span></div>
        </div>

        <div class="opts">
          ${q.opts.map((t,i)=>`
            <label class="opt">
              <input type="${multi ? "checkbox" : "radio"}" name="${q.id}" value="${i}" />
              <div>${t}</div>
            </label>
          `).join("")}
        </div>

        <div class="rowBtns">
          <button class="ghost" data-hint="${q.id}">ğŸ’¡ æç¤º</button>
        </div>
        <div class="tip" id="${q.id}_tip"></div>
      `;
      const hintBtn = box.querySelector(`[data-hint="${q.id}"]`);
      hintBtn.addEventListener("click", ()=>{
        const t = $("#"+q.id+"_tip", root);
        t.classList.add("show");
        t.innerHTML = `<strong>æç¤ºï¼š</strong>${q.hint}`;
      });
    }

    renderScenario("l2q1", q1);
    renderScenario("l2q2", q2);

    let qOk = false;

    function readSelected(id){
      const nodes = $$(`input[name="${id}"]:checked`, root);
      return nodes.map(n=>Number(n.value)).sort((a,b)=>a-b);
    }

    function checkScenarios(){
      const a1 = readSelected(q1.id);
      const a2 = readSelected(q2.id);

      const ok1 = a1.length===1 && a1[0]===q1.ans;
      const ans2 = q2.ans.slice().sort((a,b)=>a-b);
      const ok2 = a2.length===ans2.length && a2.every((v,i)=>v===ans2[i]);

      const fb = $("#l2Fb", root);
      fb.style.display="block";
      fb.className = "feedback " + ((ok1 && ok2) ? "good" : "bad");
      fb.innerHTML = `
        <div class="title">${(ok1 && ok2) ? "âœ… æƒ…å¢ƒé¡Œå…¨å°ï¼" : "â›” é‚„éœ€è¦å†æƒ³æƒ³"}</div>
        <div>${ok1 ? "æƒ…å¢ƒ 1 æ­£ç¢ºã€‚" : "æƒ…å¢ƒ 1 éŒ¯èª¤ã€‚"}<br/>${ok2 ? "æƒ…å¢ƒ 2 æ­£ç¢ºã€‚" : "æƒ…å¢ƒ 2 éŒ¯èª¤ã€‚"}</div>
        <div class="small" style="margin-top:8px;">
          <strong>è§£æé‡é»ï¼š</strong><br/>
          â‘  è’¸æ•£ä½œç”¨å¯é€ æˆå‘ä¸Šæ‹‰åŠ›ï¼Œå½±éŸ¿æ°´åˆ†ä¸Šå‡é‹è¼¸ã€‚<br/>
          â‘¡ è‘‰ç‰‡/æ°£å­”ç‹€æ…‹èˆ‡å¤©å€™æœƒæ”¹è®Šè’¸æ•£å¼·å¼±ï¼Œé€²è€Œæ”¹è®Šé‹è¼¸é€Ÿåº¦ã€‚
        </div>
      `;
      qOk = ok1 && ok2;
      maybeEnableFinish();
      toast(qOk ? "æƒ…å¢ƒé¡Œé€šéï¼" : "å†è©¦ä¸€æ¬¡ï¼Œè¨˜å¾—é€£çµè’¸æ•£èˆ‡æ‹‰åŠ›ã€‚", qOk ? "good" : "bad");
    }

    $("#l2Check", root).addEventListener("click", checkScenarios);

    function maybeEnableFinish(){
      $("#l2Finish", root).disabled = !(simRan && qOk);
    }

    $("#l2Finish", root).addEventListener("click", ()=>{
      state.completed[1] = true;
      state.passPoints[1] = 10;
      renderMap(); updateHeaderButtons(); setLevelStatus();
      toast("ç¬¬ 2 é—œé€šé—œï¼ç²å¾— +10 åˆ†ã€‚","good");
    });
  }

  /* =========================================
     LEVEL 3: Animal structure
  ========================================= */
  function renderLevel3(root){
    root.innerHTML = `
      <div class="level-title">
        <h2>ç¬¬3é—œï½œå‹•ç‰©çš„é‹è¼¸æ§‹é€ </h2>
        <span class="tag">æ’åºé¡Œ</span>
        <span class="tag">é»æ“Šæ­ç¤º/é…å°</span>
      </div>

      <div class="kpi">
        <div class="box"><span>æœ¬é—œé€šé—œåˆ†</span><strong class="mono">+10</strong></div>
        <div class="box"><span>ä»»å‹™</span><strong class="mono">2</strong><span class="small">æ’åº + ç“£è†œé…å°</span></div>
      </div>

      <div class="split">
        <div class="panel">
          <div class="note">
            <strong>ä»»å‹™ 1ï½œæ’åºï¼š</strong>æŠŠã€Œè¡€æ¶²åœ¨è¡€ç®¡ç³»çµ±ä¸­ã€ç”±å¿ƒè‡Ÿå‡ºç™¼åˆ°å›å¿ƒè‡Ÿçš„å…¸å‹äº¤æ›è·¯å¾‘æ’é †åºã€‚<br/>
            <span class="small">æç¤ºï¼šå‹•è„ˆ â†’ å¾®è¡€ç®¡ï¼ˆäº¤æ›ï¼‰ â†’ éœè„ˆ</span>
          </div>

          <div class="sortList" id="sortList"></div>

          <div class="rowBtns">
            <button class="ghost" id="sortCheck">âœ… æª¢æŸ¥æ’åº</button>
            <button class="ghost" id="sortShuffle">ğŸ² é‡æ–°æ‰“äº‚</button>
          </div>

          <div class="feedback" id="l3SortFb" style="display:none;"></div>
        </div>

        <div class="panel">
          <div class="note">
            <strong>ä»»å‹™ 2ï½œç“£è†œé…å°ï¼š</strong>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ­ç¤ºæç¤ºï¼Œé¸å‡ºæ­£ç¢ºç­”æ¡ˆã€‚<br/>
            <span class="small">æ ¸å¿ƒæ¦‚å¿µï¼šè¡€æ¶²ç¶­æŒã€Œå–®å‘æµå‹•ã€ï¼Œç“£è†œç”¨ä¾†ã€Œé˜²æ­¢é€†æµã€ã€‚</span>
          </div>

          <div class="panel" style="margin-top:12px;">
            <div class="inline">
              <button class="ghost" id="reveal1">ğŸ‘ï¸ æ­ç¤ºæç¤ºï¼šæˆ¿å®¤ç“£</button>
              <button class="ghost" id="reveal2">ğŸ‘ï¸ æ­ç¤ºæç¤ºï¼šåŠæœˆç“£</button>
            </div>
            <div class="tip" id="l3Tip"></div>
          </div>

          <div class="qCard" id="l3Q"></div>

          <div class="rowBtns">
            <button class="primary" id="l3Finish" disabled>ğŸ å®Œæˆæœ¬é—œï¼ˆ+10ï¼‰</button>
          </div>
        </div>
      </div>
    `;

    /* Sort list */
    const correct = ["å‹•è„ˆï¼ˆé›¢å¿ƒï¼‰","å¾®è¡€ç®¡ï¼ˆç‰©è³ªäº¤æ›ï¼‰","éœè„ˆï¼ˆå›å¿ƒï¼‰"];
    let items = ["å¾®è¡€ç®¡ï¼ˆç‰©è³ªäº¤æ›ï¼‰","éœè„ˆï¼ˆå›å¿ƒï¼‰","å‹•è„ˆï¼ˆé›¢å¿ƒï¼‰"];

    function renderSort(){
      const list = $("#sortList", root);
      list.innerHTML = "";
      items.forEach((t, idx)=>{
        const div = document.createElement("div");
        div.className = "sortItem";
        div.draggable = true;
        div.dataset.idx = String(idx);
        div.innerHTML = `
          <div class="handle">â‰¡</div>
          <div><strong style="color:var(--text)">${idx+1}.</strong> <span style="color:var(--muted)">${t}</span></div>
        `;
        div.addEventListener("dragstart", e=>{
          e.dataTransfer.setData("text/plain", String(idx));
        });
        div.addEventListener("dragover", e=>e.preventDefault());
        div.addEventListener("drop", e=>{
          e.preventDefault();
          const from = Number(e.dataTransfer.getData("text/plain"));
          const to = idx;
          if(from===to) return;
          const temp = items[from];
          items.splice(from,1);
          items.splice(to,0,temp);
          renderSort();
        });
        list.appendChild(div);
      });
    }
    renderSort();

    $("#sortShuffle", root).addEventListener("click", ()=>{
      items = items.sort(()=>Math.random()-0.5);
      renderSort();
      $("#l3SortFb", root).style.display="none";
      toast("å·²æ‰“äº‚ï¼Œé‡æ–°æ’åºã€‚","warn");
    });

    let sortOk = false;
    function checkSort(){
      sortOk = items.join("|") === correct.join("|");
      const fb = $("#l3SortFb", root);
      fb.style.display="block";
      fb.className = "feedback " + (sortOk ? "good" : "bad");
      fb.innerHTML = `
        <div class="title">${sortOk ? "âœ… æ’åºæ­£ç¢º" : "â›” æ’åºä¸æ­£ç¢º"}</div>
        <div>${sortOk ? "ä½ å·²æ­£ç¢ºæ’åºï¼šå‹•è„ˆ â†’ å¾®è¡€ç®¡ï¼ˆäº¤æ›ï¼‰ â†’ éœè„ˆã€‚" : "å†æƒ³æƒ³ï¼šç‰©è³ªäº¤æ›ä¸»è¦ç™¼ç”Ÿåœ¨ã€Œå¾®è¡€ç®¡ã€ã€‚"}</div>
        <div class="small" style="margin-top:8px;">è§£æï¼šå‹•è„ˆæŠŠè¡€æ¶²ç”±å¿ƒè‡Ÿé€å‡ºï¼Œå¾®è¡€ç®¡æ˜¯äº¤æ›ç«™ï¼Œéœè„ˆæŠŠè¡€æ¶²é€å›å¿ƒè‡Ÿã€‚</div>
      `;
      maybeEnableFinish();
      toast(sortOk ? "æ’åºé€šéï¼" : "å†èª¿æ•´ä¸€ä¸‹é †åºã€‚", sortOk ? "good":"bad");
    }
    $("#sortCheck", root).addEventListener("click", checkSort);

    /* Reveal tips */
    const tip = $("#l3Tip", root);
    const revealed = {a:false,b:false};

    $("#reveal1", root).addEventListener("click", ()=>{
      revealed.a = true;
      tip.classList.add("show");
      tip.innerHTML = `<strong>æˆ¿å®¤ç“£ï¼ˆæç¤ºï¼‰</strong><br/>ä½æ–¼å¿ƒæˆ¿èˆ‡å¿ƒå®¤ä¹‹é–“ï¼ŒåŠŸèƒ½æ˜¯<strong>é˜²æ­¢è¡€æ¶²ç”±å¿ƒå®¤å›æµåˆ°å¿ƒæˆ¿</strong>ã€‚`;
      maybeEnableFinish();
    });
    $("#reveal2", root).addEventListener("click", ()=>{
      revealed.b = true;
      tip.classList.add("show");
      tip.innerHTML = `<strong>åŠæœˆç“£ï¼ˆæç¤ºï¼‰</strong><br/>ä½æ–¼å¿ƒå®¤èˆ‡å‹•è„ˆï¼ˆä¸»å‹•è„ˆ/è‚ºå‹•è„ˆï¼‰äº¤ç•Œï¼ŒåŠŸèƒ½æ˜¯<strong>é˜²æ­¢è¡€æ¶²ç”±å‹•è„ˆå›æµåˆ°å¿ƒå®¤</strong>ã€‚`;
      maybeEnableFinish();
    });

    /* Matching question */
    const qBox = $("#l3Q", root);
    qBox.innerHTML = `
      <div class="qHead">
        <div>
          <div class="qid">L3Q</div>
          <div class="qtxt">ä¸‹åˆ—å“ªä¸€å¥æœ€èƒ½ç¸½çµã€Œç“£è†œã€å­˜åœ¨çš„ç†ç”±ï¼Ÿ</div>
        </div>
        <div class="pill"><span>å–®é¸</span></div>
      </div>

      <div class="opts">
        ${[
          "è®“è¡€æ¶²å¯ä»¥åœ¨å¿ƒè‡Ÿå…§è‡ªç”±ä¾†å›æ··åˆ",
          "é¿å…è¡€æ¶²é€†æµï¼Œç¶­æŒå–®å‘æµå‹•",
          "è®“è¡€æ¶²åœç•™æ›´ä¹…ä»¥ä¾¿å¸æ”¶é¤Šåˆ†",
          "å¢åŠ è¡€æ¶²ä¸­æ°§æ°£å«é‡"
        ].map((t,i)=>`
          <label class="opt">
            <input type="radio" name="l3" value="${i}" />
            <div>${t}</div>
          </label>
        `).join("")}
      </div>

      <div class="rowBtns">
        <button class="ghost" id="l3Check">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
        <button class="ghost" id="l3Hint">ğŸ’¡ æç¤º</button>
      </div>

      <div class="tip" id="l3HintBox"></div>
      <div class="feedback" id="l3Fb" style="display:none;"></div>
    `;

    $("#l3Hint", root).addEventListener("click", ()=>{
      const hb = $("#l3HintBox", root);
      hb.classList.add("show");
      hb.innerHTML = `<strong>æç¤ºï¼š</strong>æŠŠã€Œå–®å‘ã€èˆ‡ã€Œé€†æµã€æ”¾é€²ä½ çš„ç­”æ¡ˆç†ç”±è£¡ã€‚`;
    });

    let valveOk = false;
    $("#l3Check", root).addEventListener("click", ()=>{
      const v = $("input[name='l3']:checked", root);
      const fb = $("#l3Fb", root);
      fb.style.display="block";
      valveOk = !!(v && Number(v.value)===1);
      fb.className = "feedback " + (valveOk ? "good" : "bad");
      fb.innerHTML = `
        <div class="title">${valveOk ? "âœ… ç­”å°" : "â›” ç­”éŒ¯"}</div>
        <div>è§£æï¼šç“£è†œï¼ˆæˆ¿å®¤ç“£/åŠæœˆç“£ï¼‰ç”¨ä¾†<strong>é˜²æ­¢é€†æµ</strong>ï¼Œç¢ºä¿è¡€æ¶²ç¶­æŒ<strong>å–®å‘æµå‹•</strong>ã€‚</div>
      `;
      maybeEnableFinish();
      toast(valveOk ? "ç“£è†œæ¦‚å¿µæ­£ç¢ºï¼" : "å†æƒ³ä¸€æ¬¡ï¼šç“£è†œæœ€é‡è¦åŠŸèƒ½æ˜¯é˜²é€†æµã€‚", valveOk ? "good":"bad");
    });

    function maybeEnableFinish(){
      const ok = sortOk && valveOk && (revealed.a || revealed.b);
      $("#l3Finish", root).disabled = !ok;
    }

    $("#l3Finish", root).addEventListener("click", ()=>{
      state.completed[2] = true;
      state.passPoints[2] = 10;
      renderMap(); updateHeaderButtons(); setLevelStatus();
      toast("ç¬¬ 3 é—œé€šé—œï¼ç²å¾— +10 åˆ†ã€‚","good");
    });
  }

  /* =========================================
     LEVEL 4: Animal transport
  ========================================= */
  function renderLevel4(root){
    root.innerHTML = `
      <div class="level-title">
        <h2>ç¬¬4é—œï½œå‹•ç‰©çš„é‹è¼¸</h2>
        <span class="tag">è·¯å¾‘ä»»å‹™</span>
        <span class="tag">ç‰©è³ªäº¤æ›ç«™</span>
      </div>

      <div class="kpi">
        <div class="box"><span>æœ¬é—œé€šé—œåˆ†</span><strong class="mono">+10</strong></div>
        <div class="box"><span>ä»»å‹™</span><strong class="mono">2</strong><span class="small">é«”å¾ªç’° + è‚ºå¾ªç’°</span></div>
      </div>

      <div class="panel">
        <div class="note">
          <strong>ç©æ³•ï¼š</strong>è«‹ä¾åºé»æ“Šã€Œè·¯å¾‘ç¯€é»ã€å®Œæˆå¾ªç’°ã€‚ç•¶ä½ é»åˆ°äº¤æ›ç«™ï¼Œæœƒè·³å‡ºæå•ï¼šäº¤æ›äº†ä»€éº¼ï¼Ÿ<br/>
          <span class="small">æ ¸å¿ƒæ¦‚å¿µï¼šé«”å¾ªç’°æŠŠå«æ°§è¡€é€åˆ°èº«é«”äº¤æ›ï¼›è‚ºå¾ªç’°æŠŠç¼ºæ°§è¡€é€åˆ°è‚ºæ›æ°£å†å›å¿ƒè‡Ÿã€‚</span>
        </div>

        <div class="pathGrid" style="margin-top:12px;">
          <div class="pathBoard" id="sysBoard"></div>
          <div class="pathBoard" id="pulBoard"></div>
        </div>

        <div class="divider"></div>

        <div class="note"><strong>é€šé—œæ¢ä»¶ï¼š</strong>å…©å€‹å¾ªç’°éƒ½å®Œæˆï¼Œä¸¦åœ¨äº¤æ›ç«™å›ç­”æ­£ç¢ºã€‚</div>

        <div class="rowBtns">
          <button class="primary" id="l4Finish" disabled>ğŸ å®Œæˆæœ¬é—œï¼ˆ+10ï¼‰</button>
        </div>
      </div>
    `;

    const tasks = {
      systemic: {
        name:"é«”å¾ªç’°ï¼ˆå«æ°§è¡€â†’èº«é«”â†’å›å¿ƒï¼‰",
        token:"å«æ°§è¡€",
        tokenClass:"oxygen",
        seq:[
          {key:"LV", label:"å·¦å¿ƒå®¤"},
          {key:"AO", label:"ä¸»å‹•è„ˆ"},
          {key:"CAPB", label:"èº«é«”å¾®è¡€ç®¡ï¼ˆäº¤æ›ç«™ï¼‰", exchange:true,
            ask:"åœ¨èº«é«”çµ„ç¹”äº¤æ›ç«™ï¼šå“ªäº›ç‰©è³ªå¾è¡€é€²å…¥ç´°èƒï¼Ÿå“ªäº›å¾ç´°èƒé€²å…¥è¡€ï¼Ÿ",
            answerKeywords:[["æ°§æ°£","é¤Šåˆ†"],["äºŒæ°§åŒ–ç¢³"]]
          },
          {key:"VEIN", label:"éœè„ˆ"},
          {key:"RA", label:"å³å¿ƒæˆ¿"}
        ]
      },
      pulmonary: {
        name:"è‚ºå¾ªç’°ï¼ˆç¼ºæ°§è¡€â†’è‚ºâ†’å›å¿ƒï¼‰",
        token:"ç¼ºæ°§è¡€",
        tokenClass:"",
        seq:[
          {key:"RV", label:"å³å¿ƒå®¤"},
          {key:"PA", label:"è‚ºå‹•è„ˆ"},
          {key:"CAPL", label:"è‚ºå¾®è¡€ç®¡/è‚ºæ³¡ï¼ˆäº¤æ›ç«™ï¼‰", exchange:true,
            ask:"åœ¨è‚ºéƒ¨äº¤æ›ç«™ï¼šå“ªäº›ç‰©è³ªå¾è‚ºæ³¡é€²å…¥è¡€ï¼Ÿå“ªäº›å¾è¡€é€²å…¥è‚ºæ³¡ï¼Ÿ",
            answerKeywords:[["æ°§æ°£"],["äºŒæ°§åŒ–ç¢³"]]
          },
          {key:"PV", label:"è‚ºéœè„ˆ"},
          {key:"LA", label:"å·¦å¿ƒæˆ¿"}
        ]
      }
    };

    const status = {
      systemic:{i:0, done:false},
      pulmonary:{i:0, done:false}
    };

    function renderBoard(id, taskKey){
      const t = tasks[taskKey];
      const box = $("#"+id, root);
      box.innerHTML = `
        <div style="display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
          <div>
            <div style="font-weight:900">${t.name}</div>
            <div class="small">ä¾åºé»ç¯€é»ï¼š${t.seq.map(x=>x.label).join(" â†’ ")}</div>
          </div>
          <div class="token">
            <div class="ball ${t.tokenClass}"></div>
            <div>
              <div style="font-weight:900">${t.token}</div>
              <small>é»ç¯€é»å‰é€²</small>
            </div>
          </div>
        </div>

        <div class="nodes" id="${taskKey}_nodes"></div>

        <div class="rowBtns" style="margin-top:10px;">
          <button class="ghost" id="${taskKey}_reset">ğŸ§½ é‡ç½®æ­¤å¾ªç’°</button>
        </div>

        <div class="feedback" id="${taskKey}_fb" style="display:none;"></div>
      `;

      const nodesWrap = $("#"+taskKey+"_nodes", root);
      t.seq.forEach((node, idx)=>{
        const n = document.createElement("div");
        n.className = "n";
        n.dataset.task = taskKey;
        n.dataset.idx = String(idx);
        n.innerHTML = `<strong>${idx+1}</strong>ï½œ${node.label}`;
        n.addEventListener("click", ()=> onPick(taskKey, idx));
        nodesWrap.appendChild(n);
      });

      $("#"+taskKey+"_reset", root).addEventListener("click", ()=>{
        status[taskKey].i = 0;
        status[taskKey].done = false;
        $$("#"+taskKey+"_nodes .n", root).forEach(n=>n.classList.remove("ok","bad"));
        $("#"+taskKey+"_fb", root).style.display = "none";
        toast("å·²é‡ç½®æ­¤å¾ªç’°ã€‚","warn");
        maybeEnableFinish();
      });
    }

    function askExchange(node){
      const input = prompt(node.ask + "\n\nè«‹ç”¨ä¸€å¥è©±å›ç­”ï¼ˆå¯åŒ…å«é—œéµè©ï¼šæ°§æ°£/é¤Šåˆ†/äºŒæ°§åŒ–ç¢³ï¼‰ã€‚");
      if(!input) return false;
      const text = input.replace(/\s+/g,"").toLowerCase();
      const groupA = node.answerKeywords[0].some(k=> text.includes(k));
      const groupB = node.answerKeywords[1].some(k=> text.includes(k));
      return groupA && groupB;
    }

    function onPick(taskKey, idx){
      const t = tasks[taskKey];
      const expect = status[taskKey].i;
      const nodesEls = $$("#"+taskKey+"_nodes .n", root);
      nodesEls.forEach(el=> el.classList.remove("bad"));

      if(idx !== expect){
        nodesEls[idx].classList.add("bad");
        toast("é †åºä¸å°å–”ï¼è«‹ä¾åºå®Œæˆè·¯å¾‘ã€‚","bad");
        return;
      }

      nodesEls[idx].classList.add("ok");
      status[taskKey].i++;

      const node = t.seq[idx];
      if(node.exchange){
        const ok = askExchange(node);
        const fb = $("#"+taskKey+"_fb", root);
        fb.style.display = "block";
        fb.className = "feedback " + (ok ? "good":"bad");
        fb.innerHTML = `
          <div class="title">${ok ? "âœ… äº¤æ›ç«™å›ç­”æ­£ç¢º" : "â›” äº¤æ›ç«™å›ç­”éœ€è¦ä¿®æ­£"}</div>
          <div class="small">
            è§£æï¼šèº«é«”çµ„ç¹”äº¤æ›â€”æ°§æ°£/é¤Šåˆ†ç”±è¡€â†’ç´°èƒï¼ŒäºŒæ°§åŒ–ç¢³ç”±ç´°èƒâ†’è¡€ï¼›è‚ºéƒ¨äº¤æ›â€”æ°§æ°£ç”±è‚ºæ³¡â†’è¡€ï¼ŒäºŒæ°§åŒ–ç¢³ç”±è¡€â†’è‚ºæ³¡ä¸¦å‘¼å‡ºã€‚
          </div>
        `;
        if(!ok){
          toast("äº¤æ›ç«™å›ç­”ä¸å®Œæ•´ï¼Œè«‹é‡ç½®å¾Œå†æŒ‘æˆ°ã€‚","bad");
          status[taskKey].i = 0;
          nodesEls.forEach(el=> el.classList.remove("ok"));
          return;
        }
      }

      if(status[taskKey].i >= t.seq.length){
        status[taskKey].done = true;
        const fb = $("#"+taskKey+"_fb", root);
        fb.style.display = "block";
        fb.className = "feedback good";
        fb.innerHTML = `
          <div class="title">âœ… ${t.name} å®Œæˆï¼</div>
          <div class="small">é‡é»ï¼šå¾ªç’°è·¯å¾‘ + äº¤æ›ç«™ï¼ˆå¾®è¡€ç®¡/è‚ºæ³¡ï¼‰æ˜¯ç†è§£ç‰©è³ªäº¤æ›çš„é—œéµã€‚</div>
        `;
        toast(`${t.name} å®Œæˆï¼`, "good");
        maybeEnableFinish();
      }
    }

    function maybeEnableFinish(){
      $("#l4Finish", root).disabled = !(status.systemic.done && status.pulmonary.done);
    }

    renderBoard("sysBoard", "systemic");
    renderBoard("pulBoard", "pulmonary");

    $("#l4Finish", root).addEventListener("click", ()=>{
      state.completed[3] = true;
      state.passPoints[3] = 10;
      renderMap(); updateHeaderButtons(); setLevelStatus();
      toast("ç¬¬ 4 é—œé€šé—œï¼ç²å¾— +10 åˆ†ã€‚","good");
    });
  }

  /* =========================================
     LEVEL 5: Final challenge
  ========================================= */
  function startLevel5Timer(root){
    if(state.level5.timerId) return;
    state.level5.started = true;
    state.level5.startTs = Date.now();
    state.level5.secondsLeft = 180;
    state.level5.overtime = false;
    state.level5.finished = false;

    const timerEl = $("#l5Timer", root);
    timerEl.textContent = formatTime(state.level5.secondsLeft);

    state.level5.timerId = setInterval(()=>{
      state.level5.secondsLeft -= 1;
      timerEl.textContent = formatTime(state.level5.secondsLeft);
      if(state.level5.secondsLeft <= 0){
        state.level5.overtime = true;
        timerEl.classList.add("bad");
      }
    }, 1000);
  }
  function stopLevel5Timer(){
    if(state.level5.timerId){
      clearInterval(state.level5.timerId);
      state.level5.timerId = null;
    }
  }

  function renderLevel5(root){
    if(!state.completed[3]){
      root.innerHTML = `
        <div class="level-title">
          <h2>ç¬¬5é—œï½œé‹è¼¸å¤§æŒ‘æˆ°</h2>
          <span class="tag">çµç®—è©•é‡</span>
        </div>
        <div class="panel">
          <div class="feedback bad">
            <div class="title">ğŸ”’ å°šæœªè§£é–</div>
            <div>è«‹å…ˆå®Œæˆç¬¬ 1ï½4 é—œå¾Œå†é€²å…¥ç¬¬ 5 é—œã€‚</div>
          </div>
        </div>
      `;
      return;
    }

    root.innerHTML = `
      <div class="level-title">
        <h2>ç¬¬5é—œï½œé‹è¼¸å¤§æŒ‘æˆ° / ç¸½çµæ€§è©•é‡</h2>
        <span class="tag">æ··åˆé¡Œå‹</span>
        <span class="tag">è¨ˆæ™‚ 180 ç§’ï¼ˆå¯è¶…æ™‚æ‰£åˆ†ï¼‰</span>
      </div>

      <div class="kpi">
        <div class="box"><span>è¨ˆæ™‚å™¨</span><strong id="l5Timer" class="mono">03:00</strong><span class="small">è¶…æ™‚æœƒè®Šè² æ•¸</span></div>
        <div class="box"><span>ç¬¬1~4é—œé€šé—œåˆ†</span><strong class="mono" id="l5PassPts">40</strong><span class="small">æ¯é—œ +10</span></div>
        <div class="box"><span>ç¬¬5é—œç›®å‰å¾—åˆ†</span><strong class="mono" id="l5NowScore">0</strong><span class="small">æ»¿åˆ† 100</span></div>
      </div>

      <div class="panel">
        <div class="note">
          <strong>è¨ˆåˆ†è¦å‰‡ï¼ˆæœ¬é—œæ¯é¡Œæ»¿åˆ† 10ï¼‰ï¼š</strong><br/>
          ç¬¬ä¸€æ¬¡ç­”å°=10ï¼›ç¬¬äºŒæ¬¡=6ï¼›ç¬¬ä¸‰æ¬¡=3ï¼›ä»éŒ¯=0ã€‚æ¯ç­”éŒ¯ä¸€æ¬¡é¡å¤– <strong>-2</strong>ï¼ˆæœ€ä½ä¸ä½æ–¼ 0ï¼‰ã€‚<br/>
          <strong>è¨ˆæ™‚åŠ æ¸›åˆ†ï¼š</strong>å‰©é¤˜æ¯ 10 ç§’ +1ï¼ˆä¸Šé™ +10ï¼‰ï¼›è¶…æ™‚æ¯ 10 ç§’ -1ï¼ˆä¸‹é™ -10ï¼‰ã€‚
        </div>
        <div class="rowBtns">
          <button class="primary" id="l5Start">â± é–‹å§‹ä½œç­”ï¼ˆé–‹å§‹è¨ˆæ™‚ï¼‰</button>
          <button class="ghost" id="l5Reset">ğŸ§½ æ¸…ç©ºæœ¬é—œä½œç­”</button>
          <button class="ghost" id="l5FinishBtn" disabled>ğŸ äº¤å·ä¸¦çµç®—</button>
        </div>
      </div>

      <div id="l5Questions" style="margin-top:12px;"></div>

      <div class="divider"></div>

      <div class="report" id="l5Report" style="display:none;"></div>
      <div class="footerSpace"></div>
    `;

    $("#l5PassPts", root).textContent = String(state.passPoints.reduce((a,b)=>a+b,0));

    const qWrap = $("#l5Questions", root);
    qWrap.innerHTML = "";
    Q.forEach(q=>{
      const card = document.createElement("div");
      card.className = "qCard";
      card.dataset.qid = q.id;
      card.innerHTML = renderQuestionCard(q);
      qWrap.appendChild(card);
      wireQuestion(card, q, root);
    });

    const timerEl = $("#l5Timer", root);
    timerEl.textContent = formatTime(state.level5.started ? state.level5.secondsLeft : 180);
    if(state.level5.started && state.level5.overtime) timerEl.classList.add("bad");

    if(state.level5.started && !state.level5.timerId && !state.level5.finished){
      state.level5.timerId = setInterval(()=>{
        state.level5.secondsLeft -= 1;
        timerEl.textContent = formatTime(state.level5.secondsLeft);
        if(state.level5.secondsLeft <= 0){
          state.level5.overtime = true;
          timerEl.classList.add("bad");
        }
      }, 1000);
    }

    $("#l5Start", root).addEventListener("click", ()=>{
      if(state.level5.started){ toast("è¨ˆæ™‚å·²é–‹å§‹ã€‚","warn"); return; }
      startLevel5Timer(root);
      toast("é–‹å§‹ä½œç­”ï¼è¨ˆæ™‚å•Ÿå‹•ã€‚","good");
      $("#l5Start", root).disabled = true;
      enableQuestionInputs(qWrap, true);
    });

    $("#l5Reset", root).addEventListener("click", ()=>{
      if(!confirm("è¦æ¸…ç©ºç¬¬ 5 é—œä½œç­”èˆ‡åˆ†æ•¸å—ï¼Ÿï¼ˆè¨ˆæ™‚ä¹Ÿæœƒé‡ç½®ï¼‰")) return;
      stopLevel5Timer();
      state.level5 = { started:false, startTs:null, timerId:null, secondsLeft:180, qAttempts:{}, qScore:{}, qWrong:{}, qDone:{}, overtime:false, finished:false };
      renderLevel();
      toast("ç¬¬ 5 é—œå·²æ¸…ç©ºã€‚","good");
    });

    $("#l5FinishBtn", root).addEventListener("click", ()=>{ finishLevel5(root); });

    enableQuestionInputs(qWrap, state.level5.started && !state.level5.finished);
    $("#l5Start", root).disabled = state.level5.started;
    updateL5ScoreUI(root);
    updateFinishButton(root);

    if(state.level5.finished){
      showReport(root);
      enableQuestionInputs(qWrap, false);
      $("#l5FinishBtn", root).disabled = true;
      $("#l5Start", root).disabled = true;
    }
  }

  function enableQuestionInputs(qWrap, enabled){
    $$("input, textarea, button[data-action]", qWrap).forEach(el=>{
      if(el.dataset.action === "hint") return;
      el.disabled = !enabled;
    });
  }

  function renderQuestionCard(q){
    const typeLabel = q.type==="single" ? "å–®é¸" : q.type==="multi" ? "å¤šé¸" : q.type==="dragmatch" ? "æ‹–æ”¾é…å°" : q.type==="order" ? "æ’åº" : q.type==="short" ? "çŸ­ç­”" : "é¡Œç›®";
    const head = `
      <div class="qHead">
        <div>
          <div class="qid">${q.id}ï½œ${typeLabel}</div>
          <div class="qtxt">${q.stem}</div>
        </div>
        <div class="pill">
          <span>ä½œç­”æ¬¡æ•¸</span>
          <strong class="mono" data-attempts="${q.id}">0</strong>
        </div>
      </div>
    `;
    let body = "";

    if(q.type==="single" || q.type==="multi"){
      const multi = q.type==="multi";
      body = `
        <div class="opts">
          ${q.opts.map((t,i)=>`
            <label class="opt">
              <input type="${multi ? "checkbox" : "radio"}" name="${q.id}" value="${i}" />
              <div>${t}</div>
            </label>
          `).join("")}
        </div>
      `;
    }

    if(q.type==="dragmatch"){
      body = `
        <div class="note small" style="margin-top:8px;">æŠŠå·¦å´åè©æ‹–åˆ°å³å´æè¿°æ¬„ä½ã€‚</div>
        <div class="split" style="margin-top:10px;">
          <div class="panel">
            <div class="dragRow">
              ${q.pairs.map(p=>`<div class="chip" draggable="true" data-drag="${p.left}" data-q="${q.id}">${p.left}</div>`).join("")}
            </div>
          </div>
          <div class="panel" style="display:grid;gap:10px;">
            ${q.pairs.map((p,idx)=>`
              <div class="dropZone" data-zone="${q.id}:${idx}">
                <div class="label">${p.right}</div>
                <div class="slot">æ‹–åˆ°é€™è£¡</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }

    if(q.type==="order"){
      body = `
        <div class="opts">
          ${q.items.map((t,i)=>`
            <label class="opt">
              <input type="radio" name="${q.id}" value="${i}" />
              <div>${t}</div>
            </label>
          `).join("")}
        </div>
      `;
    }

    if(q.type==="short"){
      body = `
        <div style="margin-top:10px;">
          <textarea rows="3" name="${q.id}" placeholder="è«‹ç”¨ 1~2 å¥è©±å›ç­”ï¼Œå»ºè­°åŒ…å«é—œéµè©ã€‚"></textarea>
        </div>
        <div class="small" style="margin-top:8px;">é—œéµè©æç¤ºï¼š<span class="mono">${q.keywords.join("ã€")}</span></div>
      `;
    }

    const foot = `
      <div class="rowBtns">
        <button class="ghost" data-action="hint" data-qid="${q.id}">ğŸ’¡ æç¤º</button>
        <button class="primary" data-action="submit" data-qid="${q.id}">âœ… é€å‡ºæ­¤é¡Œ</button>
      </div>
      <div class="tip" id="${q.id}_hint"></div>
      <div class="feedback" id="${q.id}_fb" style="display:none;"></div>
    `;

    return head + body + foot;
  }

  function wireQuestion(card, q, root){
    const hintBtn = card.querySelector(`button[data-action="hint"][data-qid="${q.id}"]`);
    hintBtn.addEventListener("click", ()=>{
      const box = card.querySelector(`#${q.id}_hint`);
      box.classList.add("show");
      box.innerHTML = `<strong>æç¤ºï¼š</strong>${q.hint}`;
    });

    if(q.type==="dragmatch"){
      const chips = $$('.chip[data-q="'+q.id+'"]', card);
      const zones = $$(`.dropZone[data-zone^="${q.id}:"]`, card);
      const placed = {};
      chips.forEach(ch=>{
        ch.addEventListener("dragstart", e=>{
          e.dataTransfer.setData("text/plain", ch.dataset.drag);
        });
      });
      zones.forEach(z=>{
        z.addEventListener("dragover", e=>e.preventDefault());
        z.addEventListener("drop", e=>{
          e.preventDefault();
          const val = e.dataTransfer.getData("text/plain");
          placed[z.dataset.zone] = val;
          z.querySelector(".slot").textContent = "å·²æ”¾å…¥ï¼š" + val;
          toast(`å·²æ”¾å…¥ï¼š${val}`, "good");
        });
      });
      card._dragPlaced = placed;
    }

    const submitBtn = card.querySelector(`button[data-action="submit"][data-qid="${q.id}"]`);
    submitBtn.addEventListener("click", ()=>{
      if(!state.level5.started){
        toast("è«‹å…ˆæŒ‰ã€Œé–‹å§‹ä½œç­”ã€å•Ÿå‹•è¨ˆæ™‚ã€‚", "warn");
        return;
      }
      if(state.level5.finished){
        toast("å·²äº¤å·ï¼Œä¸èƒ½å†ä½œç­”ã€‚", "warn");
        return;
      }
      evaluateQuestion(card, q, root);
    });

    const attemptsEl = card.querySelector(`[data-attempts="${q.id}"]`);
    attemptsEl.textContent = String(state.level5.qAttempts[q.id] || 0);

    if(state.level5.qDone[q.id]){
      submitBtn.disabled = true;
      const fb = card.querySelector(`#${q.id}_fb`);
      fb.style.display = "block";
      fb.className = "feedback good";
      fb.innerHTML = `
        <div class="title">âœ… å·²å®Œæˆæ­¤é¡Œ</div>
        <div class="small">æœ¬é¡Œå¾—åˆ†ï¼š<strong class="mono">${state.level5.qScore[q.id] ?? 0}</strong>ï¼10</div>
        <div class="small" style="margin-top:6px;"><strong>è§£æï¼š</strong>${q.explain}</div>
      `;
      $$("input, textarea", card).forEach(el=> el.disabled = true);
    }
  }

  function readSelections(q, rootEl){
    const sel = $$(`input[name="${q.id}"]:checked`, rootEl)
      .map(n=>Number(n.value))
      .sort((a,b)=>a-b);
    return sel;
  }

  function normalizeText(s){
    return (s||"")
      .toLowerCase()
      .replace(/\s+/g,"")
      .replace(/[ï¼Œã€‚ï¼›ã€ï¼!ï¼Ÿ?ï¼ˆï¼‰()ã€Œã€"']/g,"");
  }

  function evaluateQuestion(card, q, root){
    const qid = q.id;
    const prevAttempts = state.level5.qAttempts[qid] || 0;
    const prevWrong = state.level5.qWrong[qid] || 0;

    if(prevAttempts >= 3){
      toast("æ­¤é¡Œå·²é” 3 æ¬¡ä½œç­”ä¸Šé™ã€‚","warn");
      return;
    }

    let correct = false;

    if(q.type==="single"){
      const s = readSelections(q, card);
      correct = (s.length===1 && s[0]===q.ans[0]);
    }
    if(q.type==="multi"){
      const s = readSelections(q, card);
      const ans = q.ans.slice().sort((a,b)=>a-b);
      correct = (s.length===ans.length && s.every((v,i)=>v===ans[i]));
    }
    if(q.type==="order"){
      const s = readSelections(q, card);
      correct = (s.length===1 && s[0]===q.correctIndex);
    }
    if(q.type==="dragmatch"){
      const placed = card._dragPlaced || {};
      const okAll = q.pairs.every((p, idx)=>{
        const zoneKey = `${q.id}:${idx}`;
        return placed[zoneKey] === p.left;
      });
      const filled = q.pairs.every((p, idx)=> (card._dragPlaced||{})[`${q.id}:${idx}`]);
      correct = okAll && filled;
    }
    if(q.type==="short"){
      const ta = card.querySelector(`textarea[name="${q.id}"]`);
      const text = normalizeText(ta ? ta.value : "");
      correct = q.keywords.every(k => text.includes(normalizeText(k)));
    }

    const attemptsNow = prevAttempts + 1;
    state.level5.qAttempts[qid] = attemptsNow;

    if(!correct) state.level5.qWrong[qid] = prevWrong + 1;
    else state.level5.qWrong[qid] = prevWrong;

    const fb = card.querySelector(`#${qid}_fb`);
    fb.style.display = "block";

    const attemptsEl = card.querySelector(`[data-attempts="${qid}"]`);
    attemptsEl.textContent = String(attemptsNow);

    if(correct){
      const base = baseScoreByAttempts(attemptsNow);
      const wrongs = state.level5.qWrong[qid] || 0;
      const earned = clamp(base - wrongs*2, 0, 10);
      state.level5.qScore[qid] = earned;
      state.level5.qDone[qid] = true;

      fb.className = "feedback good";
      fb.innerHTML = `
        <div class="title">âœ… æ­£ç¢ºï¼</div>
        <div class="small">
          ç¬¬ ${attemptsNow} æ¬¡ç­”å°ï¼šåŸºç¤åˆ† <strong class="mono">${base}</strong>ï¼Œ
          éŒ¯èª¤æ‰£åˆ† <strong class="mono">-${wrongs*2}</strong>ï¼Œ
          æœ¬é¡Œå¾—åˆ† <strong class="mono">${earned}</strong>ï¼10
        </div>
        <div class="small" style="margin-top:6px;"><strong>è§£æï¼š</strong>${q.explain}</div>
      `;

      $$("input, textarea", card).forEach(el=> el.disabled = true);
      card.querySelector(`button[data-action="submit"][data-qid="${qid}"]`).disabled = true;
      toast(`ç­”å° ${qid}ï¼ˆ+${earned}ï¼‰`, "good");
    }else{
      const left = 3 - attemptsNow;
      fb.className = "feedback bad";
      fb.innerHTML = `
        <div class="title">â›” ä¸æ­£ç¢º</div>
        <div class="small">å·²ä½œç­” <strong class="mono">${attemptsNow}</strong> æ¬¡ï¼Œå‰©é¤˜ <strong class="mono">${left}</strong> æ¬¡ã€‚</div>
        <div class="small" style="margin-top:6px;"><strong>æé†’ï¼š</strong>${q.hint}</div>
        <div class="small" style="margin-top:6px;"><strong>è§£æï¼ˆå…ˆçœ‹æ–¹å‘ï¼‰ï¼š</strong>${q.explain}</div>
      `;
      toast(`å†è©¦ä¸€æ¬¡ï¼š${qid}`, "bad");

      if(attemptsNow >= 3){
        state.level5.qScore[qid] = 0;
        state.level5.qDone[qid] = true;
        $$("input, textarea", card).forEach(el=> el.disabled = true);
        card.querySelector(`button[data-action="submit"][data-qid="${qid}"]`).disabled = true;
        fb.innerHTML = `
          <div class="title">â›” å·²é” 3 æ¬¡ä¸Šé™ï¼Œæœ¬é¡Œ 0 åˆ†</div>
          <div class="small">å»ºè­°ï¼šå›çœ‹æç¤ºèˆ‡è§£æï¼ŒæŠ“ä½é—œéµå­—ï¼ˆå¦‚ã€Œè’¸æ•£æ‹‰åŠ›ã€ã€Œä¾›æ‡‰éƒ¨/éœ€æ±‚éƒ¨ã€ã€Œå–®å‘/é€†æµã€ã€Œé«”å¾ªç’°/è‚ºå¾ªç’°ã€ï¼‰ã€‚</div>
          <div class="small" style="margin-top:6px;"><strong>è§£æï¼š</strong>${q.explain}</div>
        `;
      }
    }

    updateL5ScoreUI(root);
    updateFinishButton(root);
  }

  function computeLevel5Raw(){
    const scores = Object.values(state.level5.qScore);
    const sum = scores.reduce((a,b)=>a+(Number(b)||0),0);
    return clamp(sum, 0, 100);
  }

  function computeTimeBonus(){
    const sec = state.level5.secondsLeft;
    const unit = Math.floor(sec / 10);
    return clamp(unit, -10, 10);
  }

  function computeTotal(){
    const pass = state.passPoints.reduce((a,b)=>a+b,0);
    const l5 = computeLevel5Raw();
    const bonus = computeTimeBonus();
    const total = clamp(pass + l5 + bonus, 0, 150);
    return { pass, l5, bonus, total, grade: gradeOf(total) };
  }

  function updateL5ScoreUI(root){
    const el = $("#l5NowScore", root);
    if(el) el.textContent = String(computeLevel5Raw());
  }

  function updateFinishButton(root){
    const allDone = Q.every(q => state.level5.qDone[q.id]);
    const btn = $("#l5FinishBtn", root);
    if(!btn) return;
    btn.disabled = !(state.level5.started && allDone && !state.level5.finished);
  }

  function finishLevel5(root){
    stopLevel5Timer();
    state.level5.finished = true;

    const result = computeTotal();
    state.completed[4] = true;

    const best = loadBest();
    const nowDate = new Date().toLocaleString("zh-TW", {hour12:false});
    const payload = { total: result.total, grade: result.grade, date: nowDate };

    if(!best || payload.total > best.total){
      saveBest(payload);
      toast("ğŸ‰ æ–°çš„æœ€ä½³æˆç¸¾å·²ä¿å­˜ï¼", "good");
    }else{
      toast("å·²çµç®—ä¸¦ä¿å­˜æœ¬æ¬¡æˆç¸¾ï¼ˆæœªè¶…éæœ€ä½³ï¼‰ã€‚", "good");
    }
    renderBest();

    enableQuestionInputs($("#l5Questions", root), false);
    $("#l5FinishBtn", root).disabled = true;

    showReport(root);
    renderMap(); updateHeaderButtons(); setLevelStatus();
  }

  function showReport(root){
    const rep = $("#l5Report", root);
    rep.style.display = "block";

    const r = computeTotal();
    const wrongList = Q
      .filter(q => (state.level5.qScore[q.id] || 0) === 0)
      .map(q => q.id + "ï¼š" + q.stem);

    const rows = Q.map(q=>{
      const sc = state.level5.qScore[q.id] ?? 0;
      const at = state.level5.qAttempts[q.id] ?? 0;
      const wg = state.level5.qWrong[q.id] ?? 0;
      const ok = sc > 0;
      return `
        <tr>
          <td><span class="chipMini ${ok ? "good":"bad"}">${q.id}</span></td>
          <td>${at}</td>
          <td>${wg}</td>
          <td><strong class="mono" style="color:var(--text)">${sc}</strong></td>
          <td class="small">${q.explain}</td>
        </tr>
      `;
    }).join("");

    rep.innerHTML = `
      <div style="display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
        <div>
          <div style="font-weight:900;font-size:16px;">ğŸ“„ æˆç¸¾å–®</div>
          <div class="small">ç­‰ç¬¬ï¼š<strong style="color:var(--text)">${r.grade}</strong>ï½œç¸½åˆ†ï¼š<strong class="mono" style="color:var(--text)">${r.total}</strong> / 150</div>
          <div class="small" style="margin-top:6px;">
            é€šé—œåˆ†ï¼š<strong class="mono" style="color:var(--text)">${r.pass}</strong>ï½œ
            ç¬¬5é—œï¼š<strong class="mono" style="color:var(--text)">${r.l5}</strong>ï½œ
            è¨ˆæ™‚åŠ æ¸›ï¼š<strong class="mono" style="color:var(--text)">${r.bonus >= 0 ? ("+"+r.bonus) : r.bonus}</strong>
          </div>
        </div>

        <div class="pill">
          <span>è¨ˆæ™‚</span>
          <strong class="mono">${formatTime(state.level5.secondsLeft)}</strong>
          <span class="small">${state.level5.overtime ? "ï¼ˆè¶…æ™‚ï¼‰" : "ï¼ˆå‰©é¤˜ï¼‰"}</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="panel">
        <div class="note">
          <strong>éŒ¯é¡Œæ¸…å–®ï¼ˆæœ¬é¡Œ 0 åˆ†è¦–ç‚ºéœ€è¦å›é¡§ï¼‰ï¼š</strong><br/>
          ${wrongList.length ? wrongList.map(x=>`â€¢ ${x}`).join("<br/>") : "ğŸ‰ æœ¬æ¬¡æ²’æœ‰ 0 åˆ†é¡Œç›®ï¼"}
        </div>
      </div>

      <table class="tbl">
        <thead>
          <tr>
            <th>é¡Œè™Ÿ</th>
            <th>ä½œç­”æ¬¡æ•¸</th>
            <th>éŒ¯èª¤æ¬¡æ•¸</th>
            <th>å¾—åˆ†</th>
            <th>è§£æï¼ˆè¤‡ç¿’ç”¨ï¼‰</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>

      <div class="rowBtns" style="margin-top:12px;">
        <button class="primary" id="btnReplayL5">ğŸ” åªé‡ç©ç¬¬5é—œï¼ˆä¿ç•™æœ€ä½³æˆç¸¾ï¼‰</button>
        <button class="ghost" id="btnPrint">ğŸ–¨ï¸ åˆ—å° / å­˜æˆ PDF</button>
      </div>

      <div class="note" style="margin-top:10px;">
        <strong>è¤‡ç¿’é‡é»æç¤ºï¼š</strong><br/>
        æ¤ç‰©ï¼šæœ¨è³ªéƒ¨ï¼ˆæ°´/ç„¡æ©Ÿé¹½ã€å¸¸å‘ä¸Šï¼‰ã€éŸŒçš®éƒ¨ï¼ˆé¤Šåˆ†ã€ä¾›æ‡‰éƒ¨â†”éœ€æ±‚éƒ¨å¯é›™å‘ï¼‰ã€è’¸æ•£æ‹‰åŠ›ã€‚<br/>
        å‹•ç‰©ï¼šç“£è†œé˜²é€†æµç¶­æŒå–®å‘ï¼›é«”å¾ªç’°/è‚ºå¾ªç’°è·¯å¾‘èˆ‡äº¤æ›ç«™ï¼ˆå¾®è¡€ç®¡/è‚ºæ³¡ï¼‰çš„ç‰©è³ªäº¤æ›ã€‚
      </div>
    `;

    const btnReplay = $("#btnReplayL5", root);
    btnReplay.addEventListener("click", ()=>{
      if(!confirm("ç¢ºå®šåªé‡ç©ç¬¬ 5 é—œå—ï¼Ÿç¬¬ 1ï½4 é—œé€šé—œç‹€æ…‹æœƒä¿ç•™ã€‚")) return;
      replayLevel5Only();
    });

    $("#btnPrint", root).addEventListener("click", ()=> window.print());
  }

  function replayLevel5Only(){
    stopLevel5Timer();
    state.level5 = { started:false, startTs:null, timerId:null, secondsLeft:180, qAttempts:{}, qScore:{}, qWrong:{}, qDone:{}, overtime:false, finished:false };
    state.completed[4] = false;
    state.level = 5;
    renderLevel(); renderMap(); updateHeaderButtons(); setLevelStatus();
    toast("å·²é‡ç½®ç¬¬ 5 é—œã€‚æŒ‰ã€Œé–‹å§‹ä½œç­”ã€é‡æ–°æŒ‘æˆ°ï¼", "good");
  }

  /* ---------- Init ---------- */
  renderBest();
  renderLevel();
  renderMap();
  updateHeaderButtons();
  setLevelStatus();
})();
</script>

</body>
</html>
